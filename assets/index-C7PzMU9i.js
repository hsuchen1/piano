import mt,{useState as S,useRef as K,memo as rt,useEffect as se,useCallback as C,useMemo as ar}from"react";import lr from"react-dom/client";import{GoogleGenAI as Je,Type as ne}from"@google/genai";import*as Jt from"tone";(function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))h(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const m of o.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&h(m)}).observe(document,{childList:!0,subtree:!0});function g(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function h(s){if(s.ep)return;s.ep=!0;const o=g(s);fetch(s.href,o)}})();var Et={exports:{}},Xe={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ut;function ir(){if(Ut)return Xe;Ut=1;var t=Symbol.for("react.transitional.element"),u=Symbol.for("react.fragment");function g(h,s,o){var m=null;if(o!==void 0&&(m=""+o),s.key!==void 0&&(m=""+s.key),"key"in s){o={};for(var p in s)p!=="key"&&(o[p]=s[p])}else o=s;return s=o.ref,{$$typeof:t,type:h,key:m,ref:s!==void 0?s:null,props:o}}return Xe.Fragment=u,Xe.jsx=g,Xe.jsxs=g,Xe}var Vt;function cr(){return Vt||(Vt=1,Et.exports=ir()),Et.exports}var e=cr(),k=(t=>(t.Major="Maj",t.Minor="min",t.Dominant7th="7",t.Minor7th="m7",t.Major7th="Maj7",t.Diminished7th="dim7",t.Minor7thFlat5="m7b5",t.Suspended2="sus2",t.Suspended4="sus4",t.Major9="Maj9",t.Minor9="m9",t.Dominant9="9",t.Major6="6",t.Minor6="m6",t.Augmented="aug",t.PowerChord="5",t.Dominant7sharp9="7#9",t.Dominant7flat9="7b9",t))(k||{}),ae=(t=>(t.AcousticPiano="AcousticPiano",t.SynthPiano="SynthPiano",t.MellowSynth="MellowSynth",t.Synth="Synth",t.FMSynth="FM Synth",t.AMSynth="AM Synth",t.SampledGuitar="SampledGuitar",t.StringEnsemble="StringEnsemble",t))(ae||{}),W=(t=>(t.ClassicGrand="ClassicGrand",t.BrightUpright="BrightUpright",t.ElectricPiano="ElectricPiano",t.SimpleSynth="SimpleSynth",t.SampledGrand="SampledGrand",t.SampledGuitar="SampledGuitar",t.StringEnsemble="StringEnsemble",t))(W||{}),ge=(t=>(t.PerMeasure="PerMeasure",t.PerTwoBeats="PerTwoBeats",t.PerBeat="PerBeat",t.PerEighthNote="PerEighthNote",t.PerSixteenthNote="PerSixteenthNote",t.Custom="Custom",t))(ge||{}),D=(t=>(t.Kick="Kick",t.Snare="Snare",t.HiHatClosed="HiHatClosed",t.Tom1="Tom1",t.CrashCymbal="CrashCymbal",t))(D||{}),J=(t=>(t.Rock="Rock",t.PopFunk="PopFunk",t.JazzSwing="JazzSwing",t.Latin="Latin",t.EDM="EDM",t.Ballad="Ballad",t.SlowPop="SlowPop",t.HipHop="HipHop",t.BossaNova="BossaNova",t.Reggae="Reggae",t.Custom="Custom",t.Off="Off",t))(J||{}),be=(t=>(t.ElectricBass="ElectricBass",t.SynthBass="SynthBass",t.AcousticBass="AcousticBass",t.PopPulseBass="PopPulseBass",t))(be||{}),Q=(t=>(t.Off="Off",t.RootNotes="RootNotes",t.RootAndFifth="RootAndFifth",t.SimpleArpeggio="SimpleArpeggio",t.WalkingBassSimple="WalkingBassSimple",t.WalkingBassMelodic="WalkingBassMelodic",t.FunkSlap="FunkSlap",t.AiGenerated="AiGenerated",t))(Q||{});const it=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],dr=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],Ue=it,Xt=2,ur=4,mr=(t,u)=>{const g=[];for(let h=0;h<u;h++){const s=t+h;Ue.forEach(o=>{const m=o.includes("#")||o.includes("b");g.push({note:o,octave:s,isBlack:m,displayName:o,fullName:`${o}${s}`})})}return g},Ht=mr(Xt,ur),ht={[k.Major]:[0,4,7],[k.Minor]:[0,3,7],[k.Dominant7th]:[0,4,7,10],[k.Minor7th]:[0,3,7,10],[k.Major7th]:[0,4,7,11],[k.Diminished7th]:[0,3,6,9],[k.Minor7thFlat5]:[0,3,6,10],[k.Suspended2]:[0,2,7],[k.Suspended4]:[0,5,7],[k.Major9]:[0,4,7,11,14],[k.Minor9]:[0,3,7,10,14],[k.Dominant9]:[0,4,7,10,14],[k.Major6]:[0,4,7,9],[k.Minor6]:[0,3,7,9],[k.Augmented]:[0,4,8],[k.PowerChord]:[0,7],[k.Dominant7sharp9]:[0,4,7,10,15],[k.Dominant7flat9]:[0,4,7,10,13]},hr=120,pr=40,gr=240,xr=-10,fr=0,$t=-40,Qt=10,br=25,yr=-20,vr=30,ke={instrument:ae.SynthPiano,volume:xr,rhythmPattern:ge.PerMeasure},Qe=W.ClassicGrand,kt=!1,Mt=-12,It=J.Off,dt=4,Ve=4,Ne=()=>Array(dt).fill(null).map(()=>Array(Ve).fill(!1)),Oe=()=>({[D.Kick]:Ne(),[D.Snare]:Ne(),[D.HiHatClosed]:Ne(),[D.Tom1]:Ne(),[D.CrashCymbal]:Ne()}),Tt=!1,Rt=-5,lt=Q.Off,Dt=be.ElectricBass,jr=2,Bt=3,Zt=[{value:ge.PerMeasure,label:"每小節一次 (1 hit/bar)",hits:[{offset:"0:0:0",duration:"1n"}]},{value:ge.PerTwoBeats,label:"每兩拍一次 (2 hits/bar)",hits:[{offset:"0:0:0",duration:"2n"},{offset:"0:2:0",duration:"2n"}]},{value:ge.PerBeat,label:"每拍一次 (4 hits/bar)",hits:[{offset:"0:0:0",duration:"4n"},{offset:"0:1:0",duration:"4n"},{offset:"0:2:0",duration:"4n"},{offset:"0:3:0",duration:"4n"}]},{value:ge.PerEighthNote,label:"每八分音符一次 (8 hits/bar)",hits:Array.from({length:8},(t,u)=>({offset:`0:${Math.floor(u/2)}:${u%2*2}`,duration:"8n"}))},{value:ge.PerSixteenthNote,label:"每十六分音符一次 (16 hits/bar)",hits:Array.from({length:16},(t,u)=>({offset:`0:${Math.floor(u/4)}:${u%4}`,duration:"16n"}))},{value:ge.Custom,label:"自訂 (Custom)"}],Nr=[{value:ae.AcousticPiano,label:"鋼琴 (Piano)"},{value:ae.SynthPiano,label:"合成鋼琴 (Synth Piano)"},{value:ae.MellowSynth,label:"圓潤合成音 (Mellow Synth)"},{value:ae.SampledGuitar,label:"吉他 (Guitar)"},{value:ae.StringEnsemble,label:"弦樂合奏 (String Ensemble)"},{value:ae.Synth,label:"合成器 (Synth)"},{value:ae.FMSynth,label:"FM 合成器 (FM Synth)"},{value:ae.AMSynth,label:"AM 合成器 (AM Synth)"}],wr=[{value:W.ClassicGrand,label:"古典平台鋼琴 (Classic Grand)"},{value:W.SampledGrand,label:"真實平台鋼琴 (Sampled Grand)"},{value:W.SampledGuitar,label:"吉他 (Guitar)"},{value:W.StringEnsemble,label:"弦樂合奏 (String Ensemble)"},{value:W.BrightUpright,label:"明亮直立鋼琴 (Bright Upright)"},{value:W.ElectricPiano,label:"電鋼琴 (Electric Piano)"},{value:W.SimpleSynth,label:"基本合成器 (Simple Synth)"}],ct=[{value:D.Kick,label:"大鼓 (Kick)"},{value:D.Snare,label:"小鼓 (Snare)"},{value:D.HiHatClosed,label:"閉合銅鈸 (Hi-Hat Closed)"},{value:D.Tom1,label:"筒鼓 (Tom 1)"},{value:D.CrashCymbal,label:"碎音鈸 (Crash)"}],Ar=[{value:J.Off,label:"關閉 (Off)"},{value:J.Ballad,label:"抒情歌 (Ballad)"},{value:J.SlowPop,label:"慢速流行 (Slow Pop)"},{value:J.PopFunk,label:"流行/放克 (Pop/Funk)"},{value:J.Rock,label:"搖滾 (Rock)"},{value:J.HipHop,label:"嘻哈 (Hip-Hop)"},{value:J.EDM,label:"電子舞曲 (EDM)"},{value:J.JazzSwing,label:"爵士搖擺 (Jazz Swing)"},{value:J.Latin,label:"拉丁 (Latin)"},{value:J.BossaNova,label:"巴薩諾瓦 (Bossa Nova)"},{value:J.Reggae,label:"雷鬼 (Reggae)"},{value:J.Custom,label:"自訂 (Custom)"}],Cr={[D.Kick]:{pitchDecay:.05,octaves:10,oscillator:{type:"sine",phase:0},envelope:{attack:.001,decay:.4,sustain:.01,release:1.4,attackCurve:"exponential",releaseCurve:"exponential",decayCurve:"exponential"},volume:0},[D.Snare]:{noise:{type:"white",playbackRate:3,fadeIn:0,fadeOut:0},envelope:{attack:.001,decay:.15,sustain:0,release:.2,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"linear"},volume:-5},[D.HiHatClosed]:{noise:{type:"pink",playbackRate:5,fadeIn:0,fadeOut:0},envelope:{attack:.001,decay:.05,sustain:0,release:.08,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"linear"},volume:-15},[D.Tom1]:{pitchDecay:.08,octaves:4,oscillator:{type:"sine",phase:0},envelope:{attack:.001,decay:.2,sustain:.01,release:.1,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"exponential"},volume:-3},[D.CrashCymbal]:{harmonicity:5.1,modulationIndex:32,resonance:4e3,octaves:1.5,envelope:{attack:.001,decay:1,sustain:0,release:1,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"exponential"},volume:-10}},Sr=[{value:be.ElectricBass,label:"電貝斯 (Electric Bass)"},{value:be.SynthBass,label:"合成貝斯 (Synth Bass)"},{value:be.AcousticBass,label:"木貝斯 (Acoustic Bass)"},{value:be.PopPulseBass,label:"流行脈動貝斯 (Pop Pulse Bass)"}],Pr=[{value:Q.Off,label:"關閉 (Off)"},{value:Q.RootNotes,label:"根音 (Root Notes)"},{value:Q.RootAndFifth,label:"根音與五音 (Root & Fifth)"},{value:Q.SimpleArpeggio,label:"簡單琶音 (Simple Arpeggio)"},{value:Q.WalkingBassSimple,label:"簡易行走貝斯 (Simple Walking Bass)"},{value:Q.WalkingBassMelodic,label:"旋律行走貝斯 (Melodic Walking Bass)"},{value:Q.FunkSlap,label:"放克貝斯線 (Funk Slap)"},{value:Q.AiGenerated,label:"🤖 AI 生成貝斯線 (AI Generated)"}],zt={[be.ElectricBass]:{oscillator:{type:"fatsawtooth",count:2,spread:10,phase:0},envelope:{attack:.01,decay:.3,sustain:.2,release:.5,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"exponential"},filterEnvelope:{attack:.01,decay:.1,sustain:.1,baseFrequency:200,octaves:2.6,release:.8,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"exponential",exponent:2},filter:{type:"lowpass",Q:2,frequency:1200,rolloff:-12,detune:0,gain:0},volume:-6},[be.SynthBass]:{oscillator:{type:"square",phase:0},envelope:{attack:.02,decay:.1,sustain:.8,release:.4,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"exponential"},filterEnvelope:{attack:.02,decay:.05,sustain:.2,baseFrequency:100,octaves:3,release:1,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"exponential",exponent:2},filter:{type:"lowpass",Q:3,frequency:800,rolloff:-12,detune:0,gain:0},volume:-8},[be.AcousticBass]:{oscillator:{type:"sine",phase:0},envelope:{attack:.01,decay:.6,sustain:.1,release:.4,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"exponential"},filterEnvelope:{attack:.005,decay:.2,sustain:.05,baseFrequency:300,octaves:2,release:.5,attackCurve:"linear",releaseCurve:"exponential",decayCurve:"exponential",exponent:2},filter:{type:"lowpass",Q:1.5,frequency:1e3,rolloff:-12,detune:0,gain:0},volume:-4}},je=(t=[],u=[],g=[],h=[],s=[])=>{const o={[D.Kick]:Ne(),[D.Snare]:Ne(),[D.HiHatClosed]:Ne(),[D.Tom1]:Ne(),[D.CrashCymbal]:Ne()},m=(p,w)=>{o[p]&&w.forEach(b=>{const j=Math.floor(b/Ve),T=b%Ve;o[p][j]&&(o[p][j][T]=!0)})};return m(D.Kick,t),m(D.Snare,u),m(D.HiHatClosed,g),m(D.Tom1,h),m(D.CrashCymbal,s),o},Er={[J.Rock]:je([0,8],[4,12],[0,2,4,6,8,10,12,14]),[J.PopFunk]:je([0,3,6,8,11,14],[4,12],[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],[],[0]),[J.JazzSwing]:je([0,9],[4,13],[2,5,8,11,14]),[J.Latin]:je([0,7,8,15],[4,12],[0,2,4,5,6,8,10,12,13,14]),[J.EDM]:je([0,4,8,12],[4,12],[2,6,10,14]),[J.Ballad]:je([0],[8],[0,2,4,6,8,10,12,14]),[J.SlowPop]:je([0,6],[8],[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]),[J.HipHop]:je([0,7],[4,12],[0,2,4,6,8,10,12,14]),[J.BossaNova]:je([0,3,8,11],[4,12],[0,2,4,6,8,10,12,14]),[J.Reggae]:je([8],[8],[2,6,10,14])},Ot={[W.ClassicGrand]:{oscillator:{type:"fatsine",phase:0,spread:30,count:3},envelope:{attack:.005,decay:.7,sustain:.1,release:.8,attackCurve:"linear",decayCurve:"exponential",releaseCurve:"exponential"},volume:-6},[W.BrightUpright]:{oscillator:{type:"fatsquare",spread:15,count:2,phase:0},envelope:{attack:.008,decay:.5,sustain:.05,release:.6,attackCurve:"linear",decayCurve:"exponential",releaseCurve:"exponential"},volume:-7},[W.ElectricPiano]:{oscillator:{type:"fmsine",harmonicity:2,modulationIndex:1.5,phase:0,modulationType:"square"},envelope:{attack:.01,decay:.8,sustain:.3,release:1.2,attackCurve:"linear",decayCurve:"exponential",releaseCurve:"exponential"},volume:-5},[W.SimpleSynth]:{oscillator:{type:"triangle",phase:0},envelope:{attack:.01,decay:.15,sustain:.25,release:.4,attackCurve:"linear",decayCurve:"exponential",releaseCurve:"exponential"},volume:-8}},Yt={A0:"A0.mp3",C1:"C1.mp3","D#1":"Ds1.mp3","F#1":"Fs1.mp3",A1:"A1.mp3",C2:"C2.mp3","D#2":"Ds2.mp3","F#2":"Fs2.mp3",A2:"A2.mp3",C3:"C3.mp3","D#3":"Ds3.mp3","F#3":"Fs3.mp3",A3:"A3.mp3",C4:"C4.mp3","D#4":"Ds4.mp3","F#4":"Fs4.mp3",A4:"A4.mp3",C5:"C5.mp3","D#5":"Ds5.mp3","F#5":"Fs5.mp3",A5:"A5.mp3",C6:"C6.mp3","D#6":"Ds6.mp3","F#6":"Fs6.mp3",A6:"A6.mp3",C7:"C7.mp3","D#7":"Ds7.mp3","F#7":"Fs7.mp3",A7:"A7.mp3",C8:"C8.mp3"},qt="https://tonejs.github.io/audio/salamander/",kr={oscillator:{type:"fatsawtooth",count:3,spread:20,phase:0},envelope:{attack:.01,decay:1.2,sustain:.3,release:.8,attackCurve:"linear",decayCurve:"exponential",releaseCurve:"exponential"},volume:-8},Mr={oscillator:{type:"fatsine",phase:0,spread:20,count:3},envelope:{attack:.005,decay:.8,sustain:.1,release:1,attackCurve:"linear",decayCurve:"exponential",releaseCurve:"exponential"},volume:-7},Ir={oscillator:{type:"sawtooth",phase:0},envelope:{attack:.02,decay:.5,sustain:.2,release:.5,attackCurve:"linear",decayCurve:"exponential",releaseCurve:"exponential"},volume:-9},Tr={oscillator:{type:"triangle",phase:0},envelope:{attack:.005,decay:.2,sustain:.01,release:.4,attackCurve:"linear",decayCurve:"exponential",releaseCurve:"exponential"},volume:-8},et=(t,u,g=0)=>{const h=Ue.indexOf(t);if(h===-1)return`${t}${u}`;const s=h+g,o=u+Math.floor(s/12);return`${Ue[(s%12+12)%12]}${o}`},I=Xt+1,Kt={z:{note:"C",octave:I},s:{note:"C#",octave:I},x:{note:"D",octave:I},d:{note:"D#",octave:I},c:{note:"E",octave:I},v:{note:"F",octave:I},g:{note:"F#",octave:I},b:{note:"G",octave:I},h:{note:"G#",octave:I},n:{note:"A",octave:I},j:{note:"A#",octave:I},m:{note:"B",octave:I},",":{note:"C",octave:I+1},l:{note:"C#",octave:I+1},".":{note:"D",octave:I+1},";":{note:"D#",octave:I+1},"/":{note:"E",octave:I+1},q:{note:"C",octave:I+1},2:{note:"C#",octave:I+1},w:{note:"D",octave:I+1},3:{note:"D#",octave:I+1},e:{note:"E",octave:I+1},r:{note:"F",octave:I+1},5:{note:"F#",octave:I+1},t:{note:"G",octave:I+1},6:{note:"G#",octave:I+1},y:{note:"A",octave:I+1},7:{note:"A#",octave:I+1},u:{note:"B",octave:I+1},i:{note:"C",octave:I+2},9:{note:"C#",octave:I+2},o:{note:"D",octave:I+2},0:{note:"D#",octave:I+2},p:{note:"E",octave:I+2},"[":{note:"F",octave:I+2},"=":{note:"F#",octave:I+2},"]":{note:"G",octave:I+2},backspace:{note:"G#",octave:I+2},"\\":{note:"A",octave:I+2},shift:{note:"B",octave:I-1},tab:{note:"B",octave:I}},Ft="off",Rr=[{value:"off",label:"關閉 (Off)",shortLabel:"X"},{value:"1n",label:"全音符 (Whole)",shortLabel:"1"},{value:"2n",label:"二分音符 (Half)",shortLabel:"2"},{value:"4n",label:"四分音符 (Quarter)",shortLabel:"4"},{value:"8n",label:"八分音符 (Eighth)",shortLabel:"8"},{value:"16n",label:"十六分音符 (Sixteenth)",shortLabel:"16"}],Wt="interactivePianoStudio_savedProgressions_v4",Dr=({keyData:t,onNoteAttack:u,onNoteRelease:g,isComputerKeyPressed:h,isAccompanimentActive:s})=>{const{note:o,octave:m,isBlack:p,displayName:w}=t,[b,j]=mt.useState(!1),T=h||b,G="border border-gray-700 flex flex-col items-center justify-end select-none cursor-pointer transition-all duration-75 ease-out relative group",X="bg-white text-black h-48 w-10 hover:bg-gray-200 shadow-sm",H="bg-gray-300 shadow-inner transform translate-y-px",$="bg-blue-200",Z="bg-gray-800 text-white h-32 w-6 hover:bg-gray-700 absolute z-10 shadow-md border-l-2 border-r-2 border-b-4 border-gray-900",v="bg-black border-b-2 border-black transform translate-y-px",O="bg-blue-800";let x;p?(x=Z,T?x+=` ${v}`:s&&(x+=` ${O}`)):(x=X,T?x+=` ${H}`:s&&(x+=` ${$}`));const oe=`${G} ${x} ${p?"ml-[-0.75rem]":""}`,U=()=>{u(o,m),j(!0)},te=()=>{b&&(g(o,m),j(!1))},_=M=>{M.preventDefault(),u(o,m),j(!0)},B=M=>{M.preventDefault(),b&&(g(o,m),j(!1))};return e.jsx("button",{type:"button",className:oe,onMouseDown:U,onMouseUp:te,onMouseLeave:te,onTouchStart:_,onTouchEnd:B,onTouchCancel:B,"aria-label":`${w}${m}`,"aria-pressed":T,children:e.jsxs("span",{className:`text-xs font-semibold pointer-events-none ${p?"text-gray-300 group-hover:text-white mb-1":"text-gray-600 group-hover:text-black mb-1"}`,children:[w,e.jsx("span",{className:"text-gray-500 text-[0.6rem] block",children:m})]})})},Or=({onNoteAttack:t,onNoteRelease:u,pressedKeys:g,accompanimentActiveNotes:h})=>{const m=Ht.filter(p=>!p.isBlack).length*40;return e.jsxs("div",{className:"w-full bg-gradient-to-b from-gray-700 to-gray-800 rounded-lg shadow-xl my-4 p-2 sm:p-4 select-none",children:[e.jsx("div",{className:"flex items-start relative overflow-x-auto overflow-y-hidden pb-2 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800",style:{minWidth:"100%",WebkitOverflowScrolling:"touch"},children:e.jsx("div",{className:"flex items-start relative",style:{minWidth:`${m}px`},children:Ht.map(p=>e.jsx(Dr,{keyData:p,onNoteAttack:t,onNoteRelease:u,isComputerKeyPressed:g.has(p.fullName),isAccompanimentActive:h.has(p.fullName)},p.fullName))})}),e.jsx("p",{className:"text-xs text-gray-400 mt-2 text-center",children:"提示：您可以使用電腦鍵盤彈奏 (Z,S,X,D,C... 或 Q,2,W,3,E...)"})]})},Lr=({currentTransposition:t,onTransposeChange:u})=>{const g=Ue.indexOf("C"),h=((g!==-1?g:0)+t%12+12)%12,s=Ue[h],o=m=>{u(t+m)};return e.jsxs("div",{className:"p-4 bg-gray-700 rounded-lg shadow-md",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 text-center text-gray-100",children:"移調控制"}),e.jsxs("div",{className:"flex items-center justify-center space-x-1 sm:space-x-2",children:[e.jsx("button",{onClick:()=>o(-12),className:"px-3 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-400 text-sm","aria-label":"向下移八度",children:"-Oct"}),e.jsx("button",{onClick:()=>o(-1),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400","aria-label":"向下移半音",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"text-xl sm:text-2xl font-bold w-24 sm:w-28 text-center tabular-nums bg-gray-600 px-2 sm:px-3 py-1 rounded-md",children:[s,e.jsxs("span",{className:"text-xs sm:text-sm ml-1",children:["(",t>=0?"+":"",t,")"]})]}),e.jsx("button",{onClick:()=>o(1),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400","aria-label":"向上移半音",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z",clipRule:"evenodd"})})}),e.jsx("button",{onClick:()=>o(12),className:"px-3 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-400 text-sm","aria-label":"向上移八度",children:"+Oct"})]}),e.jsx("p",{className:"text-xs text-gray-400 mt-3 text-center",children:"當彈奏琴鍵 'C' 時，實際發出的音高。"})]})},Br={[k.Major]:"Major",[k.Minor]:"Minor",[k.Dominant7th]:"Dominant 7th",[k.Minor7th]:"Minor 7th",[k.Major7th]:"Major 7th",[k.Diminished7th]:"Diminished 7th",[k.Minor7thFlat5]:"Minor 7th b5 (ø)",[k.Suspended2]:"Suspended 2nd",[k.Suspended4]:"Suspended 4th",[k.Major9]:"Major 9th",[k.Minor9]:"Minor 9th",[k.Dominant9]:"Dominant 9th",[k.Major6]:"Major 6th",[k.Minor6]:"Minor 6th",[k.Augmented]:"Augmented",[k.PowerChord]:"Power Chord (5)",[k.Dominant7sharp9]:"Dominant 7th #9",[k.Dominant7flat9]:"Dominant 7th b9"},Fr=({onAddChord:t})=>{const[u,g]=S("C"),[h,s]=S(k.Major),o=()=>{t({id:`${Date.now()}-${Math.random().toString(36).substring(2,7)}`,root:u,type:h,inversion:0})};return e.jsxs("div",{className:"p-4 bg-gray-700 rounded-lg shadow-md space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-100",children:"新增和弦至進行"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"rootNote",className:"block text-sm font-medium text-gray-300 mb-1",children:"根音"}),e.jsx("select",{id:"rootNote",value:u,onChange:m=>g(m.target.value),className:"w-full p-2.5 bg-gray-600 border border-gray-500 rounded-md text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition-colors",children:Ue.map(m=>e.jsx("option",{value:m,children:m},m))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"chordType",className:"block text-sm font-medium text-gray-300 mb-1",children:"和弦類型"}),e.jsx("select",{id:"chordType",value:h,onChange:m=>s(m.target.value),className:"w-full p-2.5 bg-gray-600 border border-gray-500 rounded-md text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition-colors",children:Object.values(k).map(m=>e.jsxs("option",{value:m,children:[Br[m]," (",m,")"]},m))})]}),e.jsx("button",{onClick:o,className:"w-full px-4 py-2.5 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-green-400",children:"新增和弦"})]})},er=mt.memo(({chord:t,onUpdate:u})=>{var s;const g=((s=ht[t.type])==null?void 0:s.length)||3,h=Math.min(g-1,4);return e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs text-gray-400 mr-1",children:"轉位:"}),Array.from({length:h+1},(o,m)=>m).map(o=>e.jsx("button",{onClick:m=>{m.stopPropagation(),u(t.id,o)},className:`
              w-5 h-5 text-xs font-mono rounded-sm transition-colors
              flex items-center justify-center
              ${t.inversion===o?"bg-blue-500 text-white":"bg-gray-500 hover:bg-gray-400 text-gray-200"}
            `,"aria-label":`設定為第 ${o} 轉位`,children:o},o))]})});er.displayName="InversionControl";const _r=({progression:t,onRemoveChord:u,onClearProgression:g,onSaveProgression:h,onReorderProgression:s,onUpdateChordInversion:o,currentlyPlayingChordIndex:m,onStyleTransfer:p,isGeneratingStyle:w,isApiKeySet:b,onSmartVoicing:j,isGeneratingVoicing:T})=>{const G=K(null),X=K(null),[H,$]=S(null),[Z,v]=S(!1),[O,x]=S(""),Y=(N,F)=>{G.current=F,N.dataTransfer.effectAllowed="move",N.dataTransfer.setData("text/plain",F.toString()),N.currentTarget.classList.add("opacity-50","bg-blue-500")},oe=N=>{N.currentTarget.classList.remove("opacity-50","bg-blue-500"),$(null),G.current=null,X.current=null},U=(N,F)=>{if(N.preventDefault(),G.current===null||G.current===F){$(null);return}X.current=F;const L=N.currentTarget.getBoundingClientRect(),q=N.clientY<L.top+L.height/2;$(q?F:F+1)},te=N=>{if(N.preventDefault(),G.current===null)return;const F=G.current;let L=X.current;H!==null&&(L=H>F?H-1:H),L!==null&&F!==L&&s(F,L),G.current=null,X.current=null,$(null),N.currentTarget.classList.remove("opacity-50","bg-blue-500")},_=N=>H===N?e.jsx("div",{className:"h-1 bg-blue-400 my-0.5 rounded-full"}):null,B=()=>{O.trim()&&(p(O.trim()),v(!1))},M=b&&t.length>0;return e.jsxs("div",{className:"p-4 bg-gray-700 rounded-lg shadow-md h-full flex flex-col",children:[Z&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",onClick:()=>v(!1),children:e.jsxs("div",{className:"bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-md",onClick:N=>N.stopPropagation(),children:[e.jsx("h4",{className:"text-xl font-bold text-purple-300 mb-3",children:"AI 風格轉換"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"輸入您想要的音樂風格，AI 將會重新詮釋您目前的和弦進行。"}),e.jsx("textarea",{rows:3,value:O,onChange:N=>x(N.target.value),className:"w-full p-2.5 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500 transition-colors placeholder-gray-500",placeholder:"例如：smooth jazz trio, epic cinematic score, 8-bit video game music...","aria-label":"Style prompt"}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-4",children:[e.jsx("button",{onClick:()=>v(!1),className:"px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-md transition-colors",children:"取消"}),e.jsx("button",{onClick:B,disabled:!O.trim(),className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed",children:"轉換"})]})]})}),e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-100",children:"和弦進行"}),e.jsxs("div",{className:"space-x-2",children:[t.length>1&&e.jsx("button",{onClick:j,disabled:!M||T||w,className:"px-3 py-1 text-xs bg-teal-600 hover:bg-teal-700 rounded text-white transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed",title:b?"使用 AI 最佳化和弦轉位":"請先設定 API 金鑰",children:"🧠 AI 智慧轉位"}),t.length>0&&e.jsx("button",{onClick:()=>v(!0),disabled:!M||w||T,className:"px-3 py-1 text-xs bg-purple-600 hover:bg-purple-700 rounded text-white transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed",title:b?"使用 AI 轉換風格":"請先設定 API 金鑰",children:"AI 風格轉換"}),t.length>0&&e.jsx("button",{onClick:h,className:"px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded text-white transition-colors",title:"儲存目前和弦進行",children:"儲存"}),t.length>0&&e.jsx("button",{onClick:g,className:"px-3 py-1 text-xs bg-red-700 hover:bg-red-800 rounded text-white transition-colors",title:"清除所有和弦",children:"全部清除"})]})]}),(w||T)&&e.jsx("div",{className:"text-center p-4 text-purple-300",children:T?"AI 轉位中...":"風格轉換中..."}),t.length===0?e.jsx("div",{className:"flex-grow flex items-center justify-center",children:e.jsxs("p",{className:"text-gray-400 text-center",children:["尚未加入任何和弦。",e.jsx("br",{}),"請使用選擇器或 AI 新增和弦以建立伴奏。"]})}):e.jsxs("ul",{className:"space-y-0.5 max-h-60 overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-500 scrollbar-track-gray-600",onDragLeave:()=>$(null),children:[t.map((N,F)=>e.jsxs(mt.Fragment,{children:[_(F),e.jsxs("li",{draggable:"true",onDragStart:L=>Y(L,F),onDragEnd:oe,onDragOver:L=>U(L,F),onDrop:L=>te(L),className:`flex justify-between items-center p-2 rounded-md shadow transition-colors duration-300 cursor-grab active:cursor-grabbing
                  ${F===m?"bg-blue-600":"bg-gray-600 hover:bg-gray-500"}`,children:[e.jsx("div",{className:"flex flex-col items-start",children:e.jsxs("span",{className:"font-mono text-sm text-gray-200",children:[e.jsxs("span",{className:"text-gray-400",children:[F+1,"."]})," ",N.root,N.type]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(er,{chord:N,onUpdate:o}),e.jsx("button",{onClick:()=>u(N.id),className:"p-1.5 text-xs bg-red-500 hover:bg-red-600 rounded text-white transition-colors focus:outline-none focus:ring-1 focus:ring-red-400","aria-label":`移除和弦 ${N.root}${N.type}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]},N.id)),_(t.length)]})]})},$r=({option:t,isSelected:u,onClick:g})=>e.jsx("button",{type:"button",onClick:g,className:`
        flex-1 px-1 py-1 text-[11px] font-mono font-semibold transition-colors duration-150
        border-t border-b border-gray-600
        first:border-l first:rounded-l-md
        last:border-r last:rounded-r-md
        focus:outline-none focus:ring-1 focus:ring-blue-400 focus:z-10
        ${u?"bg-blue-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}
      `,title:t.label,children:t.shortLabel}),Gr=({chordProgression:t,customRhythmDataForLayer:u,onUpdateBeat:g})=>!t||t.length===0?e.jsx("div",{className:"p-3 my-2 text-sm text-center text-gray-400 bg-gray-500 rounded-md",children:"請先在「和弦進行」中加入和弦以編輯自訂節奏。"}):e.jsxs("div",{className:"p-3 my-2 bg-gray-600 rounded-md space-y-2 max-h-60 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-500 scrollbar-track-gray-700",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-200 mb-2",children:"自訂節奏編輯器 (每拍音符時值)"}),t.map((h,s)=>{const o=u[h.originalIndex]||Array(4).fill(Ft);return e.jsxs("div",{className:"p-2 bg-gray-500 rounded hover:bg-gray-450 transition-colors",children:[e.jsx("div",{className:"flex items-center justify-between mb-1.5",children:e.jsxs("span",{className:"text-xs font-mono text-gray-200 truncate",title:`${h.root}${h.type}`,children:[s+1,". ",h.root,h.type]})}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:o.map((m,p)=>e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("label",{htmlFor:`beat-${h.id}-${p}`,className:"text-xs text-gray-300 mb-1",children:["第 ",p+1," 拍"]}),e.jsx("div",{id:`beat-${h.id}-${p}`,className:"inline-flex w-full",role:"group",children:Rr.map(w=>e.jsx($r,{option:w,isSelected:m===w.value,onClick:()=>g(h.originalIndex,p,w.value)},w.value))})]},p))})]},h.id)})]}),Ur=({chordProgression:t,customDrumData:u,onUpdateCell:g,onGenerateDrumPattern:h,drumPatternClipboard:s,onCopy:o,onPaste:m,generationState:p,isApiKeySet:w})=>{var Z,v;const[b,j]=S(null),[T,G]=S("");if(!t||t.length===0)return e.jsx("div",{className:"p-3 my-2 text-sm text-center text-gray-400 bg-gray-500 rounded-md",children:"請先在「和弦進行」中加入和弦以編輯自訂鼓組。"});const X=()=>{T.trim()&&b!==null&&(h(T,b),j(null))},H=p.isLoading&&p.type==="drums",$=w;return e.jsxs(e.Fragment,{children:[b!==null&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",onClick:()=>j(null),children:e.jsxs("div",{className:"bg-gray-800 rounded-lg shadow-2xl p-5 w-full max-w-md",onClick:O=>O.stopPropagation(),children:[e.jsx("h4",{className:"text-lg font-bold text-red-400 mb-2",children:"AI 鼓組生成"}),e.jsxs("p",{className:"text-sm text-gray-400 mb-4",children:["為 ",e.jsxs("span",{className:"font-bold text-white",children:[(Z=t.find(O=>O.originalIndex===b))==null?void 0:Z.root,(v=t.find(O=>O.originalIndex===b))==null?void 0:v.type]})," 和弦描述您想要的鼓點。"]}),e.jsx("textarea",{rows:3,value:T,onChange:O=>G(O.target.value),className:"w-full p-2.5 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-red-500 focus:border-red-500 transition-colors placeholder-gray-500",placeholder:"例如：a simple rock beat, a fast complex breakbeat, a sparse hip-hop groove...","aria-label":"Drum pattern prompt"}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-4",children:[e.jsx("button",{onClick:()=>{j(null),G("")},className:"px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-md transition-colors",children:"取消"}),e.jsx("button",{onClick:X,disabled:!T.trim(),className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed",children:"生成"})]})]})}),e.jsxs("div",{className:"p-3 my-2 bg-gray-550 rounded-md space-y-3 max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-500 scrollbar-track-gray-700",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-200 mb-1",children:"自訂鼓組編輯器 (Custom Drum Editor)"}),t.map((O,x)=>{const Y=u[O.originalIndex]||Oe(),oe=H&&p.drumChordIndex===O.originalIndex,U=(s==null?void 0:s.sourceIndex)===O.originalIndex,te=s!==null&&!U;return e.jsxs("div",{className:"p-2.5 bg-gray-500 rounded shadow-sm space-y-1.5 relative",children:[oe&&e.jsx("div",{className:"absolute inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center rounded z-20",children:e.jsx("span",{className:"text-red-400 animate-pulse",children:"AI 生成中..."})}),e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("h5",{className:"text-xs font-mono text-gray-200",children:e.jsxs("span",{className:"font-semibold",children:[x+1,". ",O.root,O.type]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>o(O.originalIndex),className:`px-2 py-0.5 text-xs rounded text-white transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed
                      ${U?"bg-blue-600 hover:bg-blue-700":"bg-gray-600 hover:bg-gray-500"}`,title:U?"取消複製":"複製此鼓點",children:U?"已複製":"複製"}),te&&e.jsx("button",{onClick:()=>m(O.originalIndex),className:"px-2 py-0.5 text-xs bg-green-600 hover:bg-green-700 rounded text-white transition-colors",title:"貼上已複製的鼓點",children:"貼上"}),e.jsx("button",{onClick:()=>{G(""),j(O.originalIndex)},disabled:!$||H,className:"px-2 py-0.5 text-xs bg-red-600 hover:bg-red-700 rounded text-white transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed",title:w?"使用 AI 生成此鼓點":"請先設定 API 金鑰",children:"AI"})]})]}),ct.map(_=>{const B=Y[_.value]||Array(dt).fill(null).map(()=>Array(Ve).fill(!1));return e.jsxs("div",{className:"flex items-center space-x-1 sm:space-x-2",children:[e.jsx("span",{className:"w-[60px] sm:w-[70px] text-xs text-gray-300 truncate text-right pr-1",title:_.label,children:_.label.split(" (")[0]}),e.jsx("div",{className:"flex-grow grid grid-cols-4 gap-x-0",children:[0,1,2,3].map(M=>e.jsxs("div",{className:`
                            flex flex-col items-center py-1 
                            px-1 sm:px-2
                            ${M<dt-1?"border-r border-gray-400":""}
                          `,children:[e.jsx("span",{className:"text-[0.625rem] text-gray-400 leading-tight mb-0.5",children:M+1}),e.jsx("div",{className:"flex space-x-px bg-gray-600 p-px rounded-sm shadow-inner",children:[0,1,2,3].map(N=>{var q;const F=M*Ve+N,L=((q=B[M])==null?void 0:q[N])||!1;return e.jsx("button",{type:"button",title:`${_.label} - 第 ${M+1} 拍, 第 ${N+1} 分拍`,"aria-label":`${_.label} 第 ${M+1} 拍 第 ${N+1} 分拍 ${L?"啟用":"停用"}`,"aria-pressed":L,onClick:()=>g(O.originalIndex,_.value,M,N,!L),className:`
                                    w-4 h-4 sm:w-5 sm:h-5 rounded-[2px] transition-colors duration-100
                                    focus:outline-none focus:ring-1 focus:ring-purple-400 focus:z-10
                                    ${L?"bg-red-500 hover:bg-red-400 shadow-sm":"bg-slate-500 hover:bg-slate-400"}
                                  `},F)})})]},M))})]},_.value)})]},O.id)})]})]})},tt=rt(({tabName:t,currentTab:u,onClick:g,children:h})=>{const s=t===u;return e.jsx("button",{onClick:()=>g(t),className:`px-4 py-2 text-sm font-semibold rounded-t-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:z-10
        ${s?"bg-gray-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-gray-200"}`,role:"tab","aria-selected":s,children:h})});tt.displayName="TabButton";const tr=rt(({accompanimentLayers:t,onRemoveAccompanimentLayer:u,onUpdateAccompanimentLayer:g,onAddAccompanimentLayer:h,chordProgressionForCustomEditor:s,customRhythms:o,onUpdateCustomBeat:m})=>e.jsxs("div",{className:"space-y-4",children:[t.map((p,w)=>e.jsxs("div",{className:"bg-gray-500 p-3 rounded-lg space-y-3 relative border-l-2 border-blue-500",children:[e.jsx("span",{className:"absolute -top-2 -left-2.5 w-5 h-5 bg-blue-500 text-white text-xs flex items-center justify-center rounded-full font-bold",children:w+1}),t.length>1&&e.jsx("button",{onClick:()=>u(p.id),className:"absolute top-1 right-1 p-1 bg-red-600 hover:bg-red-700 rounded-full text-white transition-colors focus:outline-none focus:ring-1 focus:ring-red-400","aria-label":`移除伴奏層 ${w+1}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:3,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:`chordVolume-${p.id}`,className:"block text-sm font-medium text-gray-300 mb-1",children:["音量: ",p.volume.toFixed(0)," dB"]}),e.jsx("input",{type:"range",id:`chordVolume-${p.id}`,min:$t,max:Qt,step:"1",value:p.volume,onChange:b=>g(p.id,"volume",parseFloat(b.target.value)),className:"w-full h-2.5 bg-gray-400 rounded-lg appearance-none cursor-pointer accent-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`chordInstrument-${p.id}`,className:"block text-sm font-medium text-gray-300 mb-1",children:"樂器"}),e.jsx("select",{id:`chordInstrument-${p.id}`,value:p.instrument,onChange:b=>g(p.id,"instrument",b.target.value),className:"w-full p-2 bg-gray-400 border border-gray-500 rounded-md text-gray-900 focus:ring-blue-500 focus:border-blue-500",children:Nr.map(b=>e.jsx("option",{value:b.value,children:b.label},b.value))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`chordRhythmPattern-${p.id}`,className:"block text-sm font-medium text-gray-300 mb-1",children:"節奏型態"}),e.jsx("select",{id:`chordRhythmPattern-${p.id}`,value:p.rhythmPattern,onChange:b=>g(p.id,"rhythmPattern",b.target.value),className:"w-full p-2 bg-gray-400 border border-gray-500 rounded-md text-gray-900 focus:ring-blue-500 focus:border-blue-500",children:Zt.map(b=>e.jsx("option",{value:b.value,children:b.label},b.value))})]}),p.rhythmPattern===ge.Custom&&e.jsx(Gr,{chordProgression:s,customRhythmDataForLayer:o[p.id]||[],onUpdateBeat:(b,j,T)=>m(p.id,b,j,T)})]},p.id)),e.jsx("button",{onClick:h,className:"w-full py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400",children:"+ 新增伴奏層"})]}));tr.displayName="ChordInstrumentPanel";const rr=rt(({drumsEnabled:t,onDrumsEnabledChange:u,drumVolume:g,onDrumVolumeChange:h,drumPattern:s,onDrumPatternChange:o,chordProgressionForCustomEditor:m,customDrumData:p,onUpdateCustomDrumCell:w,onGenerateDrumPattern:b,drumPatternClipboard:j,onCopyDrumPattern:T,onPasteDrumPattern:G,generationState:X,isApiKeySet:H})=>e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{htmlFor:"drumsEnabled",className:"text-sm font-medium text-gray-300",children:"啟用鼓組 (Enable Drums)"}),e.jsx("button",{id:"drumsEnabled",onClick:()=>u(!t),className:`px-3 py-1.5 rounded-md text-xs font-semibold transition-colors ${t?"bg-green-500 hover:bg-green-600":"bg-gray-500 hover:bg-gray-400"}`,"aria-pressed":t,children:t?"已啟用 (ON)":"已停用 (OFF)"})]}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"drumVolume",className:"block text-sm font-medium text-gray-300 mb-1",children:["音量: ",g.toFixed(0)," dB"]}),e.jsx("input",{type:"range",id:"drumVolume",min:$t,max:Qt,step:"1",value:g,onChange:$=>h(parseFloat($.target.value)),className:"w-full h-2.5 bg-gray-400 rounded-lg appearance-none cursor-pointer accent-red-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"drumPattern",className:"block text-sm font-medium text-gray-300 mb-1",children:"鼓組風格 (Pattern)"}),e.jsx("select",{id:"drumPattern",value:s,onChange:$=>o($.target.value),className:"w-full p-2 bg-gray-400 border border-gray-500 rounded-md text-gray-900 focus:ring-red-500 focus:border-red-500",children:Ar.map($=>e.jsx("option",{value:$.value,children:$.label},$.value))})]}),s===J.Custom&&e.jsx(Ur,{chordProgression:m,customDrumData:p,onUpdateCell:w,onGenerateDrumPattern:b,drumPatternClipboard:j,onCopy:T,onPaste:G,generationState:X,isApiKeySet:H})]})]}));rr.displayName="DrumKitPanel";const sr=rt(({bassEnabled:t,onBassEnabledChange:u,bassVolume:g,onBassVolumeChange:h,bassInstrument:s,onBassInstrumentChange:o,bassPattern:m,onBassPatternChange:p,onGenerateAIBassline:w,chordProgressionEmpty:b,isApiKeySet:j,generationState:T})=>{const[G,X]=S(!1),[H,$]=S(""),Z=()=>{H.trim()&&(w(H),X(!1))},v=T.isLoading&&T.type==="bass",O=j&&!b;return e.jsxs(e.Fragment,{children:[G&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",onClick:()=>X(!1),children:e.jsxs("div",{className:"bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-md",onClick:x=>x.stopPropagation(),children:[e.jsx("h4",{className:"text-xl font-bold text-yellow-300 mb-3",children:"AI 貝斯線生成"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"輸入您想要的貝斯線風格，AI 將會為您目前的和弦進行創作一段貝斯線。"}),e.jsx("textarea",{rows:3,value:H,onChange:x=>$(x.target.value),className:"w-full p-2.5 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-yellow-500 focus:border-yellow-500 transition-colors placeholder-gray-500",placeholder:"例如：a funky slap bassline, a simple melodic walking bass, a driving rock bass...","aria-label":"Bassline style prompt"}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-4",children:[e.jsx("button",{onClick:()=>X(!1),className:"px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-md transition-colors",children:"取消"}),e.jsx("button",{onClick:Z,disabled:!H.trim(),className:"px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-md transition-colors disabled:bg-yellow-800 disabled:cursor-not-allowed",children:"生成"})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{htmlFor:"bassEnabled",className:"text-sm font-medium text-gray-300",children:"啟用貝斯 (Enable Bass)"}),e.jsx("button",{id:"bassEnabled",onClick:()=>u(!t),className:`px-3 py-1.5 rounded-md text-xs font-semibold transition-colors ${t?"bg-green-500 hover:bg-green-600":"bg-gray-500 hover:bg-gray-400"}`,"aria-pressed":t,children:t?"已啟用 (ON)":"已停用 (OFF)"})]}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"bassVolume",className:"block text-sm font-medium text-gray-300 mb-1",children:["音量: ",g.toFixed(0)," dB"]}),e.jsx("input",{type:"range",id:"bassVolume",min:$t,max:br,step:"1",value:g,onChange:x=>h(parseFloat(x.target.value)),className:"w-full h-2.5 bg-gray-400 rounded-lg appearance-none cursor-pointer accent-yellow-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bassInstrument",className:"block text-sm font-medium text-gray-300 mb-1",children:"貝斯音色 (Instrument)"}),e.jsx("select",{id:"bassInstrument",value:s,onChange:x=>o(x.target.value),className:"w-full p-2 bg-gray-400 border border-gray-500 rounded-md text-gray-900 focus:ring-yellow-500 focus:border-yellow-500",children:Sr.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bassPattern",className:"block text-sm font-medium text-gray-300 mb-1",children:"貝斯線風格 (Pattern)"}),e.jsx("select",{id:"bassPattern",value:m,onChange:x=>p(x.target.value),className:"w-full p-2 bg-gray-400 border border-gray-500 rounded-md text-gray-900 focus:ring-yellow-500 focus:border-yellow-500",children:Pr.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]}),m===Q.AiGenerated&&e.jsxs("div",{className:"p-3 bg-gray-500 rounded-md mt-2",children:[e.jsx("button",{onClick:()=>{$(""),X(!0)},disabled:!O||v,className:"w-full py-2 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold rounded-md transition-colors disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed",title:j?b?"請先新增和弦":"":"請先設定 API 金鑰",children:v?"生成中...":"✨ 生成 AI 貝斯線"}),T.type==="bass"&&T.error&&e.jsx("p",{className:"text-xs text-red-300 text-center mt-2",children:T.error})]})]})]})]})});sr.displayName="BassGuitarPanel";const nr=rt(({reverbLevel:t,onReverbLevelChange:u,delayLevel:g,onDelayLevelChange:h,swing:s,onSwingChange:o})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-200",children:"全域效果與律動"}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"reverb",className:"block text-sm font-medium text-gray-300 mb-1",children:["殘響 (Reverb): ",(t*100).toFixed(0),"%"]}),e.jsx("input",{type:"range",id:"reverb",min:"0",max:"1",step:"0.01",value:t,onChange:m=>u(parseFloat(m.target.value)),className:"w-full h-2.5 bg-gray-400 rounded-lg appearance-none cursor-pointer accent-teal-500"})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"delay",className:"block text-sm font-medium text-gray-300 mb-1",children:["延遲 (Delay): ",(g*100).toFixed(0),"%"]}),e.jsx("input",{type:"range",id:"delay",min:"0",max:"1",step:"0.01",value:g,onChange:m=>h(parseFloat(m.target.value)),className:"w-full h-2.5 bg-gray-400 rounded-lg appearance-none cursor-pointer accent-cyan-500"})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"swing",className:"block text-sm font-medium text-gray-300 mb-1",children:["搖擺律動 (Swing): ",(s*100).toFixed(0),"%"]}),e.jsx("input",{type:"range",id:"swing",min:"0",max:"1",step:"0.01",value:s,onChange:m=>o(parseFloat(m.target.value)),className:"w-full h-2.5 bg-gray-400 rounded-lg appearance-none cursor-pointer accent-pink-500"})]})]}));nr.displayName="EffectsPanel";const Vr=t=>{const{bpm:u,onBpmChange:g,isBeat:h,isPlaying:s,onPlay:o,onStop:m,isAudioReady:p,chordProgressionEmpty:w,accompanimentLayers:b,onAddAccompanimentLayer:j,onRemoveAccompanimentLayer:T,onUpdateAccompanimentLayer:G,chordProgressionForCustomEditor:X,customRhythms:H,onUpdateCustomBeat:$,reverbLevel:Z,onReverbLevelChange:v,delayLevel:O,onDelayLevelChange:x,swing:Y,onSwingChange:oe,drumsEnabled:U,onDrumsEnabledChange:te,drumVolume:_,onDrumVolumeChange:B,drumPattern:M,onDrumPatternChange:N,customDrumData:F,onUpdateCustomDrumCell:L,onGenerateDrumPattern:q,drumPatternClipboard:xe,onCopyDrumPattern:ee,onPasteDrumPattern:ie,generationState:ye,isApiKeySet:Se,bassEnabled:ve,onBassEnabledChange:He,bassVolume:Le,onBassVolumeChange:Be,bassPattern:Me,onBassPatternChange:ze,bassInstrument:Ie,onBassInstrumentChange:Ye,onGenerateAIBassline:me}=t,[he,re]=S("chords"),ce=!p||w;return e.jsxs("div",{className:"p-4 bg-gray-700 rounded-lg shadow-md space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-100",children:"伴奏 (Accompaniment)"}),e.jsx("div",{className:"flex space-x-3",children:s?e.jsx("button",{onClick:m,className:"px-5 py-2.5 bg-red-600 hover:bg-red-700 rounded-md text-white font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 focus:ring-offset-gray-700",children:"停止"}):e.jsx("button",{onClick:o,disabled:ce,className:`px-5 py-2.5 rounded-md text-white font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 ${ce?"bg-gray-500 cursor-not-allowed":"bg-green-600 hover:bg-green-700 focus:ring-green-400"}`,children:"播放"})})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"bpm",className:"flex items-center text-sm font-medium text-gray-300 mb-1",children:[e.jsx("span",{className:`w-2.5 h-2.5 mr-2 rounded-full bg-purple-500 transition-all duration-75 ${h?"scale-150 opacity-100":"scale-100 opacity-50"}`,"aria-hidden":"true"}),"速度 (Tempo): ",u," BPM"]}),e.jsx("input",{type:"range",id:"bpm",min:pr,max:gr,value:u,onChange:pe=>g(parseInt(pe.target.value)),className:"w-full h-2.5 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-400"})]})]}),e.jsxs("div",{className:"border-b border-gray-600 flex space-x-1",role:"tablist",children:[e.jsx(tt,{tabName:"chords",currentTab:he,onClick:re,children:"和弦"}),e.jsx(tt,{tabName:"drums",currentTab:he,onClick:re,children:"鼓組"}),e.jsx(tt,{tabName:"bass",currentTab:he,onClick:re,children:"貝斯"}),e.jsx(tt,{tabName:"effects",currentTab:he,onClick:re,children:"效果"})]}),e.jsxs("div",{className:"bg-gray-600 p-3 rounded-b-md rounded-r-md min-h-[200px]",children:[he==="chords"&&e.jsx(tr,{accompanimentLayers:b,onAddAccompanimentLayer:j,onRemoveAccompanimentLayer:T,onUpdateAccompanimentLayer:G,chordProgressionForCustomEditor:X,customRhythms:H,onUpdateCustomBeat:$}),he==="drums"&&e.jsx(rr,{drumsEnabled:U,onDrumsEnabledChange:te,drumVolume:_,onDrumVolumeChange:B,drumPattern:M,onDrumPatternChange:N,chordProgressionForCustomEditor:X,customDrumData:F,onUpdateCustomDrumCell:L,onGenerateDrumPattern:q,drumPatternClipboard:xe,onCopyDrumPattern:ee,onPasteDrumPattern:ie,generationState:ye,isApiKeySet:Se}),he==="bass"&&e.jsx(sr,{bassEnabled:ve,onBassEnabledChange:He,bassVolume:Le,onBassVolumeChange:Be,bassPattern:Me,onBassPatternChange:ze,bassInstrument:Ie,onBassInstrumentChange:Ye,onGenerateAIBassline:me,chordProgressionEmpty:w,isApiKeySet:Se,generationState:ye}),he==="effects"&&e.jsx(nr,{reverbLevel:Z,onReverbLevelChange:v,delayLevel:O,onDelayLevelChange:x,swing:Y,onSwingChange:oe})]}),!p&&e.jsx("p",{className:"text-xs text-yellow-400 text-center mt-1",children:"點擊琴鍵或「播放」以初始化音訊引擎。"}),p&&w&&!s&&e.jsx("p",{className:"text-xs text-yellow-400 text-center mt-1",children:"請先新增和弦至和弦進行中才能播放伴奏。"})]})},Hr=({savedProgressions:t,onLoadProgression:u,onDeleteProgression:g})=>{const h=Object.keys(t);return e.jsxs("div",{className:"p-4 bg-gray-700 rounded-lg shadow-md",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-100 mb-3",children:"已儲存的和弦進行"}),h.length===0?e.jsx("p",{className:"text-gray-400 text-sm",children:"沒有已儲存的和弦進行。"}):e.jsx("ul",{className:"space-y-2 max-h-48 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-500 scrollbar-track-gray-600 pr-1",children:h.map(s=>e.jsxs("li",{className:"flex justify-between items-center p-2.5 bg-gray-600 rounded-md hover:bg-gray-500 transition-colors",children:[e.jsx("span",{className:"text-sm text-gray-200 truncate mr-2",title:s,children:s}),e.jsxs("div",{className:"space-x-2 flex-shrink-0",children:[e.jsx("button",{onClick:()=>u(s),className:"px-2.5 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded text-white transition-colors","aria-label":`載入和弦進行 ${s}`,children:"載入"}),e.jsx("button",{onClick:()=>g(s),className:"p-1.5 text-xs bg-red-600 hover:bg-red-700 rounded text-white transition-colors","aria-label":`刪除和弦進行 ${s}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]},s))})]})},zr=({isOpen:t,onClose:u})=>{if(!t)return null;const g=o=>{o.target===o.currentTarget&&u()},h=({children:o})=>e.jsx("h3",{className:"text-xl font-bold text-blue-300 mt-5 mb-2 border-b border-gray-600 pb-1",children:o}),s=({children:o})=>e.jsx("li",{className:"text-gray-300",children:o});return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4 transition-opacity duration-300",onClick:g,"aria-modal":"true",role:"dialog",children:e.jsxs("div",{className:"bg-gray-700 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col",children:[e.jsxs("header",{className:"flex justify-between items-center p-4 border-b border-gray-600",children:[e.jsxs("h2",{className:"text-2xl font-bold text-white",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 inline-block mr-2 text-blue-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),"使用教學"]}),e.jsx("button",{onClick:u,className:"p-2 text-gray-400 hover:text-white hover:bg-gray-600 rounded-full transition-colors","aria-label":"關閉教學",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("main",{className:"p-6 overflow-y-auto space-y-4 scrollbar-thin scrollbar-thumb-gray-500 scrollbar-track-gray-600",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-purple-300",children:"歡迎來到互動鋼琴工作室！"}),e.jsx("p",{className:"text-gray-300 mt-1",children:"釋放您的音樂創意！在這裡，您不僅可以自由彈奏、編曲，更能讓 AI 成為您的智慧編曲夥伴，輕鬆打造專屬伴奏。"})]}),e.jsx(h,{children:"1. 彈奏虛擬鋼琴"}),e.jsxs("ul",{className:"list-disc list-inside space-y-2",children:[e.jsxs(s,{children:[e.jsx("strong",{children:"滑鼠/觸控:"})," 直接點擊或觸碰螢幕上的琴鍵即可發聲。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"電腦鍵盤:"}),e.jsxs("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:[e.jsxs(s,{children:["中下排 (",e.jsx("code",{className:"bg-gray-800 px-1 rounded",children:"Z, S, X, D..."}),") 對應一個八度。"]}),e.jsxs(s,{children:["中上排 (",e.jsx("code",{className:"bg-gray-800 px-1 rounded",children:"Q, 2, W, 3..."}),") 對應高一個八度。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"空白鍵捷徑:"})," 您也可以隨時按下",e.jsx("code",{className:"bg-gray-800 px-1 rounded",children:"空白鍵"}),"來播放或暫停伴奏。"]})]})]})]}),e.jsx(h,{children:"2. 核心設定"}),e.jsxs("ul",{className:"list-disc list-inside space-y-2",children:[e.jsxs(s,{children:[e.jsx("strong",{children:"移調控制:"})," 使用 ",e.jsx("code",{className:"bg-gray-800 px-1 rounded",children:"+"})," 和 ",e.jsx("code",{className:"bg-gray-800 px-1 rounded",children:"-"})," 按鈕來升高或降低所有琴鍵的音高。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"主鍵盤設定:"}),e.jsxs("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:[e.jsxs(s,{children:[e.jsx("strong",{children:"音色:"})," 從下拉選單中選擇您喜歡的鋼琴或合成器音色。部分音色（如真實平台鋼琴）在首次選擇時需要短暫的載入時間。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"音量:"})," 調整您手動彈奏的琴鍵音量。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"顯示伴奏音符:"})," 開啟後，伴奏所彈奏的音符會在琴鍵上以藍色顯示。"]})]})]})]}),e.jsx(h,{children:"3. 建立您的和弦進行"}),e.jsx("p",{className:"text-gray-300",children:"您可以用兩種方式建立伴奏的和弦基礎："}),e.jsxs("ol",{className:"list-decimal list-inside space-y-2",children:[e.jsxs(s,{children:[e.jsx("strong",{children:"手動新增:"})," 在「新增和弦至進行」面板中選擇根音與和弦類型，然後點擊「新增和弦」。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"編輯和弦進行:"}),e.jsxs("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:[e.jsxs(s,{children:[e.jsx("strong",{children:"刪除:"})," 點擊和弦右側的紅色 ",e.jsx("code",{className:"bg-red-500 text-white px-1 rounded",children:"X"})," 按鈕。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"轉位:"})," 點擊和弦旁的 ",e.jsx("code",{className:"bg-gray-800 px-1 rounded",children:"0, 1, 2..."})," 按鈕來切換和弦轉位。按鈕的數量會根據和弦的複雜度（三和弦、七和弦等）自動變化。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"重新排序:"})," 按住和弦並拖曳到新的位置即可改變順序。"]})]})]}),e.jsxs(s,{children:[e.jsx("strong",{children:"儲存與載入:"}),e.jsxs("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:[e.jsxs(s,{children:[e.jsx("strong",{children:"儲存:"})," 點擊「儲存」按鈕，為您當前的和弦進行命名並保存。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"載入:"})," 在「已儲存的和弦進行」面板中，點擊「載入」以還原之前儲存的設定（包含所有樂器、節奏和效果）。"]})]})]})]}),e.jsx(h,{children:"4. AI 智慧創作 (Gemini API)"}),e.jsx("p",{className:"text-gray-300",children:"利用 AI 的強大功能，加速您的音樂創作流程！"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-2 mt-2",children:[e.jsxs(s,{children:[e.jsx("strong",{children:"第一步：設定 API 金鑰 (僅需一次)"}),e.jsxs("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:[e.jsx(s,{children:"前往「API 金鑰設定」面板。"}),e.jsx(s,{children:"將您的 Google Gemini API 金鑰貼入輸入框中並點擊「儲存」。"}),e.jsxs(s,{children:[e.jsx("strong",{children:"安全提示："}),"您的金鑰只會被安全地儲存在您自己的瀏覽器中，絕不會上傳或公開。"]})]})]}),e.jsxs(s,{children:[e.jsx("strong",{children:"AI 和弦生成:"})," 在「AI 智慧創作」面板中，用文字描述您想要的音樂風格或情緒（例如：「一首輕快的流行歌」、「悲傷的電影配樂」），然後點擊生成。AI 將會**取代**您目前編輯的內容。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"AI 風格轉換:"})," 在「和弦進行」面板中，點擊「AI 風格轉換」按鈕。輸入您想要的新風格（例如：「爵士」、「8-bit 遊戲音樂」），AI 將會重新詮釋您現有的和弦進行。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"AI 智慧轉位:"})," 在「和弦進行」面板中，點擊「🧠 AI 智慧轉位」按鈕。AI 會分析整個和弦進行，不僅讓最高音的旋律線條更平滑，同時也會維持整體的音高穩定性，避免不自然的八度跳躍，讓編曲聽起來更專業、更悅耳。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"AI 鼓組生成:"})," 在「鼓組」分頁中將風格設為「自訂」，然後在自訂鼓組編輯器中點擊任一和弦右上角的「AI」按鈕，描述您想要的鼓點即可。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"AI 貝斯線生成:"})," 在「貝斯」分頁中將風格設為「🤖 AI 生成貝斯線」，然後點擊「✨ 生成 AI 貝斯線」按鈕。描述您想要的風格，AI 就會為您的整個和弦進行創作一段完整的貝斯線。"]})]}),e.jsx(h,{children:"5. 設計您的伴奏"}),e.jsx("p",{className:"text-gray-300",children:"伴奏控制面板分為四個分頁，讓您精雕細琢您的音樂："}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"主控制 (面板頂部):"}),e.jsxs("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:[e.jsxs(s,{children:[e.jsx("strong",{children:"播放/停止:"})," 控制伴奏的啟動與停止。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"速度 (BPM):"})," 拖動滑桿調整伴奏的快慢。左側的紫色圓點會跟隨節拍閃爍。"]})]})]}),e.jsxs("li",{children:[e.jsx("strong",{children:"和弦 (Chords) 分頁:"}),e.jsxs("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:[e.jsxs(s,{children:["您可以建立",e.jsx("strong",{children:"多個伴奏層"}),"，例如一層鋼琴、一層弦樂。"]}),e.jsx(s,{children:"點擊「+ 新增伴奏層」來增加樂器。"}),e.jsxs(s,{children:["每一層都可以獨立設定",e.jsx("strong",{children:"音量"}),"、",e.jsx("strong",{children:"樂器"}),"和",e.jsx("strong",{children:"節奏型態"}),"。"]}),e.jsx(s,{children:"選擇「自訂」節奏型態後，會出現編輯器，讓您精確設定每個和弦在四拍中每一拍的音符時長。"})]})]}),e.jsxs("li",{children:[e.jsx("strong",{children:"鼓組 (Drums) 分頁:"}),e.jsxs("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:[e.jsx(s,{children:"點擊「啟用鼓組」來開啟/關閉鼓。"}),e.jsxs(s,{children:["可以調整鼓的",e.jsx("strong",{children:"音量"}),"和選擇預設的",e.jsx("strong",{children:"鼓組風格"})," (如搖滾、拉丁)。"]}),e.jsx(s,{children:"選擇「自訂」風格後，會出現詳細的編輯器，讓您為每個和弦的每一拍的 4 個分拍點擊設定鼓點。"}),e.jsx(s,{children:"在自訂模式中，您可以使用「複製」按鈕複製一個小節的鼓點，再到另一個小節點擊「貼上」，快速應用相同節奏。"})]})]}),e.jsxs("li",{children:[e.jsx("strong",{children:"貝斯 (Bass) 分頁:"}),e.jsx("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:e.jsxs(s,{children:["啟用後，可以調整貝斯的",e.jsx("strong",{children:"音量"}),"、",e.jsx("strong",{children:"音色"}),"和",e.jsx("strong",{children:"貝斯線風格"})," (如根音、簡單琶音等)。"]})})]}),e.jsxs("li",{children:[e.jsx("strong",{children:"效果 (Effects) 分頁:"}),e.jsxs("ul",{className:"list-square list-inside pl-5 mt-1 text-sm space-y-1",children:[e.jsxs(s,{children:["這裡的設定會影響",e.jsx("strong",{children:"所有"}),"聲音（包含您的手動彈奏和所有伴奏樂器）。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"殘響 (Reverb):"})," 增加空間感。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"延遲 (Delay):"})," 產生回音效果。"]}),e.jsxs(s,{children:[e.jsx("strong",{children:"搖擺律動 (Swing):"})," 讓節奏帶有搖擺感，常用於爵士樂。"]})]})]})]}),e.jsxs("div",{className:"text-center pt-4 mt-4 border-t border-gray-600",children:[e.jsx("p",{className:"text-lg font-semibold text-purple-300",children:"開始探索吧！"}),e.jsx("p",{className:"text-gray-300",children:"結合不同的樂器、節奏和效果，創造出屬於您獨一無二的音樂！"})]})]}),e.jsx("footer",{className:"p-4 text-center",children:e.jsx("button",{onClick:u,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-gray-700",children:"關閉"})})]})})},Yr=({onGenerate:t,isGenerating:u,generationError:g,isApiKeySet:h})=>{const[s,o]=S(""),[m,p]=S("auto"),w=j=>{j.preventDefault(),s.trim()&&!u&&h&&t(s.trim(),m)},b=u||!s.trim()||!h;return e.jsxs("div",{className:"p-4 bg-gray-700 rounded-lg shadow-md space-y-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-100 flex items-center",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 mr-2 text-purple-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"})}),"AI 智慧創作"]}),e.jsxs("form",{onSubmit:w,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"ai-prompt",className:"block text-sm font-medium text-gray-300 mb-1",children:"描述您想要的音樂感覺"}),e.jsx("textarea",{id:"ai-prompt",rows:3,value:s,onChange:j=>o(j.target.value),className:"w-full p-2.5 bg-gray-600 border border-gray-500 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500 transition-colors placeholder-gray-400 disabled:opacity-50",placeholder:"例如：一首輕快的流行歌、悲傷的電影配樂、4個和弦的爵士樂...",disabled:u||!h,"aria-describedby":"ai-prompt-description"}),e.jsx("p",{id:"ai-prompt-description",className:"text-xs text-gray-400 mt-1",children:"AI 將會取代目前的和弦進行。"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"num-chords",className:"block text-sm font-medium text-gray-300 mb-1",children:"和弦數量 (選填)"}),e.jsxs("select",{id:"num-chords",value:m,onChange:j=>p(j.target.value),className:"w-full p-2.5 bg-gray-600 border border-gray-500 rounded-md text-gray-100 focus:ring-purple-500 focus:border-purple-500 transition-colors disabled:opacity-50",disabled:u||!h,"aria-label":"選擇要生成的和弦數量",children:[e.jsx("option",{value:"auto",children:"自動 (4-8個)"}),Array.from({length:19},(j,T)=>T+2).map(j=>e.jsxs("option",{value:j,children:[j," 個和弦"]},j))]})]}),e.jsxs("button",{type:"submit",disabled:b,className:"w-full px-4 py-2.5 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-purple-400 disabled:bg-gray-500 disabled:cursor-not-allowed flex items-center justify-center",title:h?"":"請先在上方設定 API 金鑰",children:[u&&e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),u?"創作中...":"生成和弦進行"]}),g&&e.jsx("div",{className:"p-2 bg-red-800/50 border border-red-700 rounded-md text-xs text-red-300 text-center",role:"alert",children:g})]})]})},qr=({apiKey:t,onApiKeyChange:u})=>{const[g,h]=S(""),[s,o]=S(!!t);se(()=>{o(!!t)},[t]);const m=()=>{if(g.trim()){const w=g.trim();localStorage.setItem("gemini_api_key",w),u(w),h(""),alert("API 金鑰已儲存至您的瀏覽器。")}},p=()=>{window.confirm("確定要清除已儲存的 API 金鑰嗎？")&&(localStorage.removeItem("gemini_api_key"),u(null),alert("API 金鑰已清除。"))};return e.jsxs("div",{className:"p-4 bg-gray-700 rounded-lg shadow-md space-y-3",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-100 flex items-center",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 mr-2 text-yellow-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z",clipRule:"evenodd"})}),"API 金鑰設定"]}),e.jsx("p",{className:"text-xs text-gray-400",children:"此金鑰將僅儲存在您本機的瀏覽器中，不會上傳。這是為了讓部署到公開網站後，您能安全地使用 AI 功能。"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"password",value:g,onChange:w=>h(w.target.value),className:"flex-grow p-2 bg-gray-600 border border-gray-500 rounded-md text-gray-100 focus:ring-yellow-500 focus:border-yellow-500 transition-colors placeholder-gray-400",placeholder:"貼上您的 Gemini API 金鑰","aria-label":"Gemini API Key Input"}),e.jsx("button",{onClick:m,disabled:!g.trim(),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:bg-gray-500 disabled:cursor-not-allowed",children:"儲存"})]}),s?e.jsxs("div",{className:"flex items-center justify-between text-sm text-green-400",children:[e.jsx("span",{children:"狀態：API 金鑰已設定。"}),e.jsx("button",{onClick:p,className:"text-xs text-red-400 hover:text-red-300 underline",children:"清除金鑰"})]}):e.jsx("p",{className:"text-sm text-yellow-400",children:"狀態：尚未設定 API 金鑰。AI 功能將無法使用。"})]})},we=Jt,ut=(t,u,g)=>{if(!we||!we.Frequency)return console.error("Tone.js or Tone.Frequency is not available in getChordNotes."),[];const{root:h,type:s,inversion:o}=t,m=ht[s];if(!m)return console.error(`No intervals found for chord type: ${s}`),[];const p=et(h,u,g);try{const w=we.Frequency(p).toMidi();let b=m.map(j=>w+j);if(o>0&&b.length>1){const j=o%b.length;for(let T=0;T<j;T++)if(b.length>1){const G=b.shift();G!==void 0&&b.push(G+12)}}return b.map(j=>we.Frequency(j,"midi").toNote())}catch(w){return console.error(`Error calculating chord notes for ${h}${s} (root: ${p}):`,w),[]}},Kr=(t,u,g,h)=>{if(!we||!we.Frequency)return[];const s=ut(t,g,h);if(s.length===0)return[];const o=s[0],m=s[1]||o,p=s[2]||o;let w,b;try{const j=we.Frequency(o).toMidi();w=we.Frequency(j+12,"midi").toNote(),b=we.Frequency(j+2,"midi").toNote()}catch{w=o,b=m}switch(u){case Q.Off:return[];case Q.RootNotes:return[{note:o,timeOffset:"0:0:0",duration:"1m"}];case Q.RootAndFifth:return[{note:o,timeOffset:"0:0:0",duration:"2n"},{note:p,timeOffset:"0:2:0",duration:"2n"}];case Q.SimpleArpeggio:return[{note:o,timeOffset:"0:0:0",duration:"4n"},{note:m,timeOffset:"0:1:0",duration:"4n"},{note:p,timeOffset:"0:2:0",duration:"4n"},{note:w,timeOffset:"0:3:0",duration:"4n"}];case Q.WalkingBassSimple:return[{note:o,timeOffset:"0:0:0",duration:"4n"},{note:o,timeOffset:"0:1:0",duration:"4n"},{note:p,timeOffset:"0:2:0",duration:"4n"},{note:m,timeOffset:"0:3:0",duration:"4n"}];case Q.WalkingBassMelodic:return[{note:o,timeOffset:"0:0:0",duration:"4n"},{note:b,timeOffset:"0:1:0",duration:"4n"},{note:m,timeOffset:"0:2:0",duration:"4n"},{note:p,timeOffset:"0:3:0",duration:"4n"}];case Q.FunkSlap:return[{note:o,timeOffset:"0:0:0",duration:"16n"},{note:o,timeOffset:"0:1:0",duration:"16n"},{note:w,timeOffset:"0:1:3",duration:"16n"},{note:o,timeOffset:"0:2:0",duration:"16n"},{note:p,timeOffset:"0:3:0",duration:"16n"},{note:w,timeOffset:"0:3:3",duration:"16n"}];default:return[{note:o,timeOffset:"0:0:0",duration:"1m"}]}},Wr=(t,u)=>{const g=[],h=ht[t.type];if(!h||!we)return[];const s=h.length;for(let o=0;o<s;o++){const m={...t,inversion:o},p=ut(m,u,0);p.length>0&&g.push({inversion:o,notes:p})}return g},Jr=t=>Object.values(k).includes(t),Xr=t=>{const u=t.trim(),g=u.charAt(0).toUpperCase()+u.slice(1),h=it.indexOf(g);if(h>-1)return it[h];const s=dr.indexOf(g);return s>-1?it[s]:(console.warn(`[normalizeNoteName] Invalid note name received: "${t}"`),null)},d=Jt,Ze="samples/",Qr=.2,Lt="16n",Zr=(t,u,g,h,s,o,m,p,w,b,j,T,G,X,H,$,Z)=>{const[v,O]=S(!1),x=K(null),Y=K(null),oe=K(new Map),U=K(null),te=K({}),_=K(null),B=K(null),M=K(null),N=K(null),F=K(null),L=K(null),q=K(null),xe=K(new Map),[ee,ie]=S(0),[ye,Se]=S(!1),[ve,He]=S(t),Le=K(u),Be=K(m),[Me,ze]=S(hr),[Ie,Ye]=S(G),[me,he]=S(Qe),[re,ce]=S(!1),pe=K(ee),Fe=K(me),Ae=K(g),_e=K(h),Pe=K(o),P=K(p),de=K(b),$e=K(j),st=K(Z),nt=K(T);se(()=>{pe.current=ee},[ee]),se(()=>{Fe.current=me},[me]),se(()=>{Ae.current=g},[g]),se(()=>{_e.current=h},[h]),se(()=>{Pe.current=o},[o]),se(()=>{P.current=p},[p]),se(()=>{de.current=b},[b]),se(()=>{$e.current=j},[j]),se(()=>{st.current=Z},[Z]),se(()=>{nt.current=T},[T]),se(()=>{He(t)},[t]),se(()=>{Le.current=u},[u]),se(()=>{Be.current=m},[m]);const Te=C(l=>{let E;switch(l){case ae.AcousticPiano:E=new d.Sampler({urls:Yt,baseUrl:qt,release:1,volume:-3,onerror:f=>console.error("[useAudio] CRITICAL: Failed to load samples for AccompanimentInstrument.AcousticPiano:",f)});break;case ae.SynthPiano:E=new d.PolySynth({voice:d.Synth,options:kr});break;case ae.MellowSynth:E=new d.PolySynth({voice:d.Synth,options:Mr});break;case ae.SampledGuitar:E=new d.Sampler({urls:{A3:"guitar.wav"},baseUrl:Ze,release:1,onerror:f=>console.error("[useAudio] CRITICAL: Failed to load samples for AccompanimentInstrument.SampledGuitar:",f)});break;case ae.StringEnsemble:E=new d.Sampler({urls:{A4:"strings.wav"},baseUrl:Ze,release:1.5,onerror:f=>console.error("[useAudio] CRITICAL: Failed to load samples for AccompanimentInstrument.StringEnsemble:",f)});break;case ae.FMSynth:E=new d.PolySynth({voice:d.FMSynth,options:{volume:-10,harmonicity:3,modulationIndex:10,oscillator:{type:"sine"},envelope:{attack:.01,decay:.2,sustain:.5,release:.8}}});break;case ae.AMSynth:E=new d.PolySynth({voice:d.AMSynth,options:{volume:-10,harmonicity:2.5,oscillator:{type:"sawtooth"},envelope:{attack:.02,decay:.3,sustain:.4,release:.7}}});break;case ae.Synth:E=new d.PolySynth({voice:d.Synth,options:Tr});break;default:E=new d.PolySynth({voice:d.Synth,options:Ir})}return E},[]),Ce=C(l=>{F.current&&l.connect(F.current),L.current&&l.connect(L.current)},[]);se(()=>{if(!v)return;const l=oe.current,E=new Set(g.map(f=>f.id));for(const f of l.keys())if(!E.has(f)){const R=l.get(f);R&&(R.synth.dispose(),R.volumeNode.dispose()),l.delete(f)}g.forEach(f=>{const R=l.get(f.id);if(R){if(R.volumeNode.volume.linearRampTo(f.volume,.1),R.instrument!==f.instrument){R.synth.dispose();const r=Te(f.instrument).connect(R.volumeNode);l.set(f.id,{...R,synth:r,instrument:f.instrument})}}else{const r=new d.Volume(f.volume);Ce(r),r.toDestination();const n=Te(f.instrument).connect(r);l.set(f.id,{synth:n,volumeNode:r,instrument:f.instrument})}})},[g,v,Te,Ce]);const Ge=C((l,E)=>{x.current&&!x.current.disposed&&(x.current instanceof d.PolySynth&&x.current.releaseAll(d.now()),x.current.dispose(),x.current=null),xe.current.clear();let f=null;const R=()=>{const n=[W.SampledGrand,W.SampledGuitar,W.StringEnsemble].includes(Qe)?W.ClassicGrand:Qe;x.current=new d.PolySynth({voice:d.Synth,options:Ot[n]}).connect(E),he(n)};if(l===W.SampledGrand){ce(!0);const r=new d.Sampler({urls:Yt,baseUrl:qt,release:1,volume:-6,onload:()=>{x.current===f&&ce(!1)},onerror:n=>{console.error("Error loading sampled grand piano:",n),(x.current===f||!x.current)&&(ce(!1),f&&!f.disposed&&f.dispose(),R())}}).connect(E);return f=r,x.current=r,r}else if(l===W.SampledGuitar){ce(!0);const r=new d.Sampler({urls:{A3:"guitar.wav"},baseUrl:Ze,release:1,onload:()=>{x.current===f&&ce(!1),console.log("[useAudio] User Piano Sampler (SampledGuitar) loaded successfully.")},onerror:n=>{console.error("Error loading sampled guitar:",n),(x.current===f||!x.current)&&(ce(!1),f&&!f.disposed&&f.dispose(),R())}}).connect(E);return f=r,x.current=r,r}else if(l===W.StringEnsemble){ce(!0);const r=new d.Sampler({urls:{A4:"strings.wav"},baseUrl:Ze,release:1.5,onload:()=>{x.current===f&&ce(!1),console.log("[useAudio] User Piano Sampler (StringEnsemble) loaded successfully.")},onerror:n=>{console.error("Error loading string ensemble:",n),(x.current===f||!x.current)&&(ce(!1),f&&!f.disposed&&f.dispose(),R())}}).connect(E);return f=r,x.current=r,r}else{ce(!1);const r=l,a=[W.SampledGrand,W.SampledGuitar,W.StringEnsemble].includes(Qe)?W.ClassicGrand:Qe,i=Ot[r]||Ot[a],c=new d.PolySynth({voice:d.Synth,options:i}).connect(E);return x.current=c,c}},[]),ot=C(l=>{Object.keys(D).forEach(E=>{const f=D[E];te.current[f]&&!te.current[f].disposed&&te.current[f].dispose();const R=Cr[f];f===D.Kick||f===D.Tom1?te.current[f]=new d.MembraneSynth(R).connect(l):f===D.Snare||f===D.HiHatClosed?te.current[f]=new d.NoiseSynth(R).connect(l):f===D.CrashCymbal&&(te.current[f]=new d.MetalSynth(R).connect(l))})},[]),Ee=C((l,E)=>{if(B.current&&!B.current.disposed&&(B.current.dispose(),B.current=null),l===be.PopPulseBass)B.current=new d.Sampler({urls:{A4:"pop-pulse-bass.wav"},baseUrl:Ze,release:.5,onload:()=>console.log("[useAudio] Bass Sampler (PopPulseBass) loaded successfully."),onerror:f=>console.error("[useAudio] CRITICAL: Failed to load PopPulseBass sample:",f)}).connect(E);else{const R=zt[l]||zt[be.ElectricBass];B.current=new d.MonoSynth(R).connect(E)}return B.current},[]);se(()=>{v&&M.current&&!M.current.disposed&&Ee(j,M.current)},[j,v,Ee]);const Re=C(async()=>{if(!d)return!1;if(v)return!0;try{return await d.start(),(!F.current||F.current.disposed)&&(F.current=new d.Reverb({decay:7,wet:0}).toDestination()),(!L.current||L.current.disposed)&&(L.current=new d.FeedbackDelay({delayTime:"8n.",feedback:.7}).toDestination(),L.current.wet.value=0),(!Y.current||Y.current.disposed)&&(Y.current=new d.Volume(Ie),Ce(Y.current),Y.current.toDestination()),(!x.current||x.current.disposed)&&Ge(Fe.current,Y.current),Ae.current.forEach(l=>{if(!oe.current.has(l.id)){const E=new d.Volume(l.volume);Ce(E),E.toDestination();const f=Te(l.instrument).connect(E);oe.current.set(l.id,{synth:f,volumeNode:E,instrument:l.instrument})}}),(!_.current||_.current.disposed)&&(_.current=new d.Volume(s),Ce(_.current),_.current.toDestination()),ot(_.current),(!M.current||M.current.disposed)&&(M.current=new d.Volume(w),Ce(M.current),M.current.toDestination()),(!B.current||B.current.disposed)&&Ee($e.current,M.current),q.current||(q.current=new d.Loop(l=>{d.Draw.schedule(()=>{H(!0),setTimeout(()=>H(!1),50)},l)},"4n").start(0)),d.Transport.bpm.value=Me,d.Transport.timeSignature=4,O(!0),!0}catch(l){return console.error("Error starting Tone.js or initializing synths:",l),O(!1),!1}},[v,Me,Ie,Te,Ge,ot,s,Ee,w,Ce,H]),qe=C(()=>{d&&(Se(!1),X(null),d.Transport.state==="started"&&d.Transport.stop(d.now()),$(new Set),oe.current.forEach(l=>{l.synth.releaseAll(d.now())}),B.current&&!B.current.disposed&&(B.current instanceof d.Sampler?B.current.releaseAll(d.now()):B.current.triggerRelease(d.now())),N.current&&N.current.stop(0))},[X,$]),De=C((l,E,f)=>{if(!st.current)return;const R=d.Time(f).toSeconds();d.Draw.schedule(()=>{$(r=>new Set([...r,...l]))},E),d.Draw.schedule(()=>{$(r=>{const n=new Set(r);return l.forEach(a=>n.delete(a)),n})},E+R)},[$]);se(()=>{if(!v||!d){U.current&&(U.current.stop(0).dispose(),U.current=null),N.current&&(N.current.stop(0).dispose(),N.current=null);return}U.current&&(U.current.stop(0).dispose(),U.current=null),N.current&&(N.current.stop(0).dispose(),N.current=null);const l=ve.length>0;if(l){const R=new d.Sequence((r,n)=>{if(d.Draw.schedule(()=>{X(n.originalIndex)},r),Ae.current.forEach(a=>{const i=oe.current.get(a.id);if(!i||i.synth.disposed)return;const{synth:c}=i,y=a.rhythmPattern;if(y!==ge.Custom){const A=ut(n,Bt,pe.current),V=Zt.find(z=>z.value===y);A.length>0&&V&&V.hits&&V.hits.forEach(z=>{const le=d.Time(z.offset).toSeconds(),ue=r+le;c.triggerAttackRelease(A,z.duration,ue),De(A,ue,z.duration)})}else{const A=ut(n,Bt,pe.current),V=Le.current[a.id],z=V?V[n.originalIndex]:null;if(A.length>0&&z)for(let le=0;le<4;le++){const ue=z[le];if(ue==="off")continue;const fe=ue,or=d.Time(`0:${le}:0`).toSeconds(),Gt=r+or;c.triggerAttackRelease(A,fe,Gt),De(A,Gt,fe)}}}),_e.current&&Pe.current!==J.Off){let a;if(Pe.current===J.Custom?a=Be.current[n.originalIndex]:a=Er[Pe.current],a)for(let i=0;i<dt;i++)for(let c=0;c<Ve;c++){const y=d.Time(`0:${i}:${c}`).toSeconds(),A=r+y;Object.keys(D).forEach(V=>{var le,ue;const z=D[V];if(a&&((ue=(le=a[z])==null?void 0:le[i])!=null&&ue[c])){const fe=te.current[z];fe&&!fe.disposed&&(z===D.Kick?fe.triggerAttackRelease("C2",Lt,A):z===D.Tom1?fe.triggerAttackRelease("G2",Lt,A):z===D.CrashCymbal?d.Draw.schedule(()=>{fe&&!fe.disposed&&fe.triggerAttack(A)},A):fe.triggerAttackRelease(Lt,A))}})}}P.current&&B.current&&!B.current.disposed&&de.current!==Q.Off&&de.current!==Q.AiGenerated&&Kr(n,de.current,jr,pe.current).forEach(i=>{const c=d.Time(i.timeOffset).toSeconds(),y=r+c;B.current.triggerAttackRelease(i.note,i.duration,y),De([i.note],y,i.duration)})},ve,"1m");R.loop=!0,U.current=R}const E=de.current,f=nt.current;if(l&&E===Q.AiGenerated&&f&&f.length>0){const R=f.map(n=>({time:n.time,note:n.note,duration:n.duration})),r=new d.Part((n,a)=>{B.current&&!B.current.disposed&&P.current&&(B.current.triggerAttackRelease(a.note,a.duration,n),De([a.note],n,a.duration))},R);r.loop=!0,r.loopEnd=`${ve.length}m`,N.current=r}if(ye)if(l){const R=d.Transport.state==="started",r=d.Transport.position;R&&d.Transport.stop(),U.current&&U.current.start(0),N.current&&N.current.start(0),R?d.Transport.start(d.now(),r):d.Transport.start(d.now()+.1)}else qe()},[ve,v,ye,T,b,qe,X,De]);const pt=C((l,E,f=!1)=>{const R=()=>{if(x.current&&!x.current.disposed&&d&&!re){const r=et(l,E,pe.current);x.current.triggerAttack(r,d.now()),f&&xe.current.set(`${l}${E}`,r)}else re||Re().then(r=>{if(r&&x.current&&!x.current.disposed&&!re){const n=et(l,E,pe.current);x.current.triggerAttack(n,d.now()),f&&xe.current.set(`${l}${E}`,n)}})};v?re||R():Re().then(r=>{r&&!re&&R()})},[v,Re,re]),gt=C((l,E,f=!1)=>{let R=null;const r=`${l}${E}`;f?(R=et(l,E,pe.current),xe.current.has(r)&&xe.current.delete(r)):R=et(l,E,pe.current),R&&x.current&&!x.current.disposed&&d&&!re&&x.current.triggerRelease([R],d.now()+Qr)},[re]),xt=C(async()=>{!d||!(v||await Re())||ve.length!==0&&(ye||Se(!0))},[v,Re,ve.length,ye]),ft=C(l=>{ze(l),v&&d&&(d.Transport.bpm.value=l)},[v]),bt=C(l=>{Ye(l),v&&Y.current&&!Y.current.disposed&&(Y.current.volume.value=l)},[v]),yt=C(l=>{Fe.current===l&&!re||(he(l),v&&d&&Y.current&&!Y.current.disposed?Ge(l,Y.current):!v&&[W.SampledGrand,W.SampledGuitar,W.StringEnsemble].includes(l)&&ce(!0))},[v,Ge,re]),vt=C(l=>{x.current&&!x.current.disposed&&d&&!re&&x.current instanceof d.PolySynth&&x.current.releaseAll(d.now()),xe.current.clear(),ie(l)},[re]),jt=C(l=>{v&&F.current&&F.current.wet.linearRampTo(Math.pow(l,.6),.1)},[v]),Nt=C(l=>{v&&L.current&&L.current.wet.linearRampTo(Math.pow(l,.8),.1)},[v]),Ke=C(l=>{v&&d&&(d.Transport.swing=l*.9)},[v]),We=C(l=>{_e.current=l},[]),wt=C(l=>{v&&_.current&&!_.current.disposed&&(_.current.volume.value=l)},[v]),at=C(l=>{Pe.current=l},[]),At=C(l=>{P.current=l},[]),Ct=C(l=>{v&&M.current&&!M.current.disposed&&(M.current.volume.value=l)},[v]),St=C(l=>{de.current=l,l!==Q.AiGenerated&&N.current&&N.current.stop(0)},[]),Pt=C(l=>{$e.current=l,v&&M.current&&d&&!M.current.disposed&&Ee(l,M.current)},[v,Ee]);return se(()=>()=>{d&&(d.Transport.state!=="stopped"&&d.Transport.stop(),d.Transport.cancel()),x.current&&!x.current.disposed&&(x.current instanceof d.PolySynth&&x.current.releaseAll(d.now()),x.current.dispose()),Y.current&&!Y.current.disposed&&Y.current.dispose(),oe.current.forEach(l=>{l.synth&&!l.synth.disposed&&l.synth.dispose(),l.volumeNode&&!l.volumeNode.disposed&&l.volumeNode.dispose()}),oe.current.clear(),F.current&&!F.current.disposed&&F.current.dispose(),L.current&&!L.current.disposed&&L.current.dispose(),q.current&&!q.current.disposed&&q.current.dispose(),_.current&&!_.current.disposed&&_.current.dispose(),Object.values(te.current).filter(l=>l&&!l.disposed).forEach(l=>l.dispose()),B.current&&!B.current.disposed&&B.current.dispose(),M.current&&!M.current.disposed&&M.current.dispose(),U.current&&(U.current.stop(0),U.current.clear(),U.current.dispose()),N.current&&(N.current.stop(0),N.current.clear(),N.current.dispose()),xe.current.clear()},[]),{attackPianoNote:pt,releasePianoNote:gt,startAccompaniment:xt,stopAccompaniment:qe,setAccompanimentBPM:ft,setUserPianoInstrument:yt,setUserPianoVolume:bt,setTransposition:vt,currentTransposition:ee,isAccompanimentPlaying:ye,currentBPM:Me,currentUserPianoVolume:Ie,currentUserPianoInstrument:me,isAudioReady:v,isPianoLoading:re,setReverbLevel:jt,setDelayLevel:Nt,setSwing:Ke,setDrumsEnabled:We,setDrumVolume:wt,setDrumPattern:at,setBassEnabled:At,setBassVolume:Ct,setBassPattern:St,setBassInstrument:Pt}},es=()=>{const[t,u]=S([]),[g,h]=S(new Set),[s,o]=S({}),[m,p]=S([{id:`layer-${Date.now()}`,...ke}]),[w,b]=S(fr),[j,T]=S(kt),[G,X]=S(Mt),[H,$]=S(It),[Z,v]=S([]),[O,x]=S(null),[Y,oe]=S(Tt),[U,te]=S(Rt),[_,B]=S(lt),[M,N]=S(Dt),[F,L]=S(null),[q,xe]=S(()=>localStorage.getItem("gemini_api_key")),[ee,ie]=S({type:null,isLoading:!1,error:null}),[ye,Se]=S(null),[ve,He]=S(.1),[Le,Be]=S(.1),[Me,ze]=S(0),[Ie,Ye]=S(!1),[me,he]=S(!0),[re,ce]=S(new Set),[pe,Fe]=S(!1),[Ae,_e]=S(()=>{let r={};try{const n=window.localStorage.getItem(Wt);if(n){const a=JSON.parse(n);Object.keys(a).forEach(i=>{const c=a[i];if(c&&c.progression){const y=c.progression.map(A=>({...A,inversion:A.inversion===void 0?0:A.inversion}));c.accompanimentLayers||(c.accompanimentLayers=[{id:`layer-${Date.now()}`,instrument:c.instrument||ke.instrument,volume:c.volume||ke.volume,rhythmPattern:c.rhythmPattern||ke.rhythmPattern}]),r[i]={progression:y,accompanimentLayers:c.accompanimentLayers,customRhythms:c.customRhythms,customRhythm:c.customRhythm,drumsEnabled:c.drumsEnabled===void 0?kt:c.drumsEnabled,drumVolume:c.drumVolume===void 0?Mt:c.drumVolume,drumPattern:c.drumPattern===void 0?It:c.drumPattern,customDrumData:c.customDrumData||Array(c.progression.length).fill(null).map(()=>Oe()),bassEnabled:c.bassEnabled===void 0?Tt:c.bassEnabled,bassVolume:c.bassVolume===void 0?Rt:c.bassVolume,bassPattern:c.bassPattern===void 0?lt:c.bassPattern,bassInstrument:c.bassInstrument===void 0?Dt:c.bassInstrument,aiBassEvents:c.aiBassEvents||null}}})}}catch(n){console.error("[App.tsx] CRITICAL ERROR reading/parsing saved progressions from localStorage during init:",n),r={}}return r});se(()=>{try{const r={...Ae};Object.keys(r).forEach(n=>{r[n].customRhythm&&delete r[n].customRhythm}),window.localStorage.setItem(Wt,JSON.stringify(r))}catch(r){console.error("[App.tsx] Error saving progressions to localStorage (in useEffect):",r)}},[Ae]);const Pe=ar(()=>t.map((r,n)=>({...r,originalIndex:n})),[t]),P=Zr(Pe,s,m,j,G,H,Z,Y,U,_,M,F,w,Se,Ye,ce,me),de=C(()=>{P.stopAccompaniment(),Se(null)},[P]),$e=C(()=>{P.isAccompanimentPlaying?de():P.startAccompaniment()},[P,de]),st=r=>{b(r),P.setUserPianoVolume(r)},nt=r=>{X(r),P.setDrumVolume(r)},Te=r=>{te(r),P.setBassVolume(r)},Ce=C(r=>{He(r),P.setReverbLevel(r)},[P]),Ge=C(r=>{Be(r),P.setDelayLevel(r)},[P]),ot=C(r=>{ze(r),P.setSwing(r)},[P]),Ee=C(r=>{u(n=>[...n,r]),o(n=>{const a={...n};for(const i in a)a[i]=[...a[i],Array(4).fill(Ft)];return a}),v(n=>[...n,Oe()])},[]),Re=C(r=>{const n=t.findIndex(a=>a.id===r);n!==-1&&(u(a=>a.filter(i=>i.id!==r)),o(a=>{const i={...a};for(const c in i){const y=[...i[c]];y.splice(n,1),i[c]=y}return i}),v(a=>{const i=[...a];return i.splice(n,1),i}))},[t]),qe=C(()=>{P.isAccompanimentPlaying&&de(),u([]),o({}),v([]),x(null),L(null)},[P,de]),De=C((r,n)=>{u(a=>a.map(i=>i.id===r?{...i,inversion:n}:i))},[]),pt=C((r,n,a,i)=>{o(c=>{const y={...c},A=y[r];if(A){const V=A.map((z,le)=>{if(le===n){const ue=[...z];return ue[a]=i,ue}return z});y[r]=V}return y})},[]),gt=C((r,n,a,i,c)=>{v(y=>{const A=[...y];A[r]||(A[r]=Oe());const V={...A[r]};V[n]||(V[n]=Array(4).fill(null).map(()=>Array(4).fill(!1)));const z=V[n].map(le=>[...le]);return z[a][i]=c,V[n]=z,A[r]=V,A})},[]),xt=C(()=>{p(r=>[...r,{id:`layer-${Date.now()}-${Math.random()}`,...ke}])},[]),ft=C(r=>{p(n=>n.filter(a=>a.id!==r)),o(n=>{if(n[r]){const a={...n};return delete a[r],a}return n})},[]),bt=C((r,n,a)=>{p(i=>i.map(c=>c.id===r?{...c,[n]:a}:c)),n==="rhythmPattern"&&(a===ge.Custom?o(i=>{if(!i[r]){const c=Array(t.length).fill(null).map(()=>Array(4).fill(Ft));return{...i,[r]:c}}return i}):o(i=>{if(i[r]){const c={...i};return delete c[r],c}return i}))},[t.length]),yt=C(()=>{if(t.length===0){alert("和弦進行是空的，無法儲存。");return}let r=window.prompt("請輸入此和弦進行的名稱：");if(r===null)return;const n=r.trim();if(n===""){alert("名稱不能為空。");return}_e(a=>({...a,[n]:{progression:t,customRhythms:s,accompanimentLayers:m,drumsEnabled:j,drumVolume:G,drumPattern:H,customDrumData:Z,bassEnabled:Y,bassVolume:U,bassPattern:_,bassInstrument:M,aiBassEvents:F}})),alert(`和弦進行 "${n}" 已儲存！`)},[t,s,m,j,G,H,Z,Y,U,_,M,F]),vt=C(r=>{const n=Ae[r];if(n){P.isAccompanimentPlaying&&de();const a=n.progression.map(c=>({...c,inversion:c.inversion===void 0?0:c.inversion}));if(u(a),n.accompanimentLayers&&n.accompanimentLayers.length>0)p(n.accompanimentLayers);else{const c={id:`layer-${Date.now()}`,instrument:n.instrument||ke.instrument,volume:n.volume||ke.volume,rhythmPattern:n.rhythmPattern||ke.rhythmPattern};p([c])}const i={};n.customRhythms?o(n.customRhythms):(n.customRhythm&&(n.accompanimentLayers||[]).forEach(y=>{y.rhythmPattern===ge.Custom&&(i[y.id]=n.customRhythm)}),o(i)),T(n.drumsEnabled===void 0?kt:n.drumsEnabled),X(n.drumVolume===void 0?Mt:n.drumVolume),$(n.drumPattern===void 0?It:n.drumPattern),v(n.customDrumData||Array(n.progression.length).fill(null).map(()=>Oe())),oe(n.bassEnabled===void 0?Tt:n.bassEnabled),te(n.bassVolume===void 0?Rt:n.bassVolume),B(n.bassPattern===void 0?lt:n.bassPattern),N(n.bassInstrument===void 0?Dt:n.bassInstrument),L(n.aiBassEvents||null),x(null),alert(`和弦進行 "${r}" 已載入！`)}else alert(`無法載入和弦進行 "${r}"。`)},[Ae,P,de]),jt=C(r=>{window.confirm(`確定要刪除和弦進行 "${r}" 嗎？`)&&(_e(n=>{const a={...n};return delete a[r],a}),alert(`和弦進行 "${r}" 已刪除！`))},[]),Nt=C((r,n)=>{u(a=>{const i=Array.from(a),[c]=i.splice(r,1);return i.splice(n,0,c),i}),o(a=>{const i={...a};for(const c in i){const y=Array.from(i[c]),[A]=y.splice(r,1);y.splice(n,0,A),i[c]=y}return i}),v(a=>{const i=Array.from(a),[c]=i.splice(r,1);return i.splice(n,0,c),i})},[]),Ke=C((r,n,a=!1)=>{P.isPianoLoading||P.attackPianoNote(r,n,a)},[P]),We=C((r,n,a=!1)=>{P.isPianoLoading||P.releasePianoNote(r,n,a)},[P]),wt=r=>{xe(r)},at=C(r=>{if(!Array.isArray(r))throw new Error("AI response is not a valid array.");const n=[];for(const a of r){const i=Xr(a.root);if(!i)throw new Error(`AI returned an invalid chord root: ${a.root}`);if(!Jr(a.type))throw new Error(`AI returned an invalid chord type: ${a.type}`);n.push({id:`${Date.now()}-${Math.random().toString(36).substring(2,7)}`,root:i,type:a.type,inversion:0})}P.isAccompanimentPlaying&&de(),u(n),o({}),v(Array(n.length).fill(null).map(()=>Oe())),L(null),B(lt)},[P,de]),At=async(r,n)=>{if(!ee.isLoading){if(!q){ie({type:"chords",isLoading:!1,error:"請先在 API 設定中輸入您的 Gemini API 金鑰。"});return}if(!(t.length>0&&!window.confirm("AI 將會取代您目前的和弦進行。確定要繼續嗎？"))){ie({type:"chords",isLoading:!0,error:null});try{const a=new Je({apiKey:q}),i="You are an expert music theorist and composer. Your task is to generate a common chord progression based on the user's description. Your response MUST be in JSON format.",c=n!=="auto"?`The progression must contain exactly ${parseInt(n,10)} chords.`:"The progression should contain between 4 and 8 chords.",y=await a.models.generateContent({model:"gemini-2.5-flash",contents:`User request: '${r}'`,config:{systemInstruction:`${i} ${c}`,responseMimeType:"application/json",responseSchema:{type:ne.ARRAY,items:{type:ne.OBJECT,properties:{root:{type:ne.STRING,description:"The chord's root note, e.g., 'C', 'G#', 'Bb'"},type:{type:ne.STRING,description:`The chord type, must be one of: '${Object.values(k).join("', '")}'`}},required:["root","type"]}}}});at(JSON.parse(y.text))}catch(a){const i=a instanceof Error?a.message:"An unknown error occurred.";console.error("Error generating chord progression:",a),ie({type:"chords",isLoading:!1,error:`Generation failed: ${i}`})}finally{ie({type:null,isLoading:!1,error:null})}}}},Ct=async r=>{if(!(ee.isLoading||t.length===0)){if(!q){alert("請先在 API 設定中輸入您的 Gemini API 金鑰。");return}ie({type:"style",isLoading:!0,error:null});try{const n=new Je({apiKey:q}),a=t.map(y=>`${y.root}${y.type}`).join(", "),i=await n.models.generateContent({model:"gemini-2.5-flash",contents:`Re-harmonize the following chord progression: [${a}] into a "${r}" style.`,config:{systemInstruction:"You are a master music arranger. Your task is to re-harmonize a given chord progression into a new style specified by the user. You can use more advanced chords (e.g., sevenths, ninths, altered chords) and substitutions, but you must maintain the general harmonic flow and the same number of chords as the original. Your response MUST be a JSON array with the exact same structure and number of elements as the original progression.",responseMimeType:"application/json",responseSchema:{type:ne.ARRAY,items:{type:ne.OBJECT,properties:{root:{type:ne.STRING,description:"The chord's root note, e.g., 'C', 'G#', 'Bb'"},type:{type:ne.STRING,description:`The chord type, must be one of: '${Object.values(k).join("', '")}'`}},required:["root","type"]}}}}),c=JSON.parse(i.text);if(c.length!==t.length)throw new Error(`AI returned ${c.length} chords, but expected ${t.length}.`);at(c)}catch(n){const a=n instanceof Error?n.message:"An unknown error occurred.";console.error("Error transforming chord progression:",n),alert(`風格轉換失敗: ${a}`)}finally{ie({type:null,isLoading:!1,error:null})}}},St=async()=>{if(!(ee.isLoading||t.length<2)){if(!q){alert("請先在 API 設定中輸入您的 Gemini API 金鑰。");return}if(window.confirm("這將會由 AI 自動調整您所有和弦的轉位以獲得更流暢、音高更穩定的聲音。確定要繼續嗎？")){ie({type:"voicing",isLoading:!0,error:null});try{const r=new Je({apiKey:q}),n=t.map(y=>{const A=Wr(y,Bt);return{chord_name:`${y.root}${y.type}`,voicings:A}}),a=await r.models.generateContent({model:"gemini-2.5-flash",contents:`Analyze this chord progression and determine the optimal inversion for each chord. Progression data with all possible voicings: ${JSON.stringify(n)}`,config:{systemInstruction:"You are a music arrangement expert specializing in voice leading. For each chord in the progression, you are given a list of possible voicings, each with an inversion number and the resulting MIDI-style note names (e.g., C4). Your task is to select one voicing (by its inversion number) for each chord. Your PRIMARY goal is to ensure that the chosen chord voicing falls comfortably within a pianist's typical accompaniment range, specifically aiming for the core notes to be around B2 to C4. Your SECONDARY goal is to minimize melodic movement in the highest note between adjacent chords. Your response MUST be a JSON array of numbers. The length of the array must be identical to the input progression's length. Each number represents the chosen inversion for the corresponding chord.",responseMimeType:"application/json",responseSchema:{type:ne.ARRAY,items:{type:ne.INTEGER}}}}),i=JSON.parse(a.text);if(!Array.isArray(i)||i.length!==t.length)throw new Error(`AI returned an invalid response. Expected an array of ${t.length} numbers.`);const c=i.map((y,A)=>{var z;if(typeof y!="number")throw new Error(`AI returned a non-numeric inversion for chord ${A+1}.`);const V=(((z=ht[t[A].type])==null?void 0:z.length)||1)-1;return y<0||y>V?(console.warn(`AI returned an out-of-bounds inversion (${y}) for chord ${A+1}. Clamping to nearest valid value.`),Math.max(0,Math.min(y,V))):y});u(y=>y.map((A,V)=>({...A,inversion:c[V]})))}catch(r){const n=r instanceof Error?r.message:"An unknown error occurred.";console.error("Error with Smart Voicing:",r),alert(`AI 智慧轉位失敗: ${n}`)}finally{ie({type:null,isLoading:!1,error:null})}}}},Pt=async r=>{if(!(ee.isLoading||t.length===0)){if(!q){alert("請先在 API 設定中輸入您的 Gemini API 金鑰。");return}ie({type:"bass",isLoading:!0,error:null});try{const n=new Je({apiKey:q}),a=t.map(y=>`${y.root}${y.type}`).join(", "),i=await n.models.generateContent({model:"gemini-2.5-flash",contents:`Create a bassline for the chord progression [${a}]. The user wants a style described as: "${r}".`,config:{systemInstruction:`You are a professional bass player. Your task is to create a monophonic bassline for a given chord progression. The bassline should be musically interesting, fit the user's description, and stay within a typical bass range (E1 to G3). The response MUST be a JSON array of note events. Each event is an object with "note" (e.g., "C2"), "time" (in "measure:beat:subdivision" format, e.g., "0:0:0"), and "duration" (e.g., "4n", "8n."). The total duration should match the progression length (${t.length} measures).`,responseMimeType:"application/json",responseSchema:{type:ne.ARRAY,items:{type:ne.OBJECT,properties:{note:{type:ne.STRING,description:"The note to play, e.g., 'A2'"},time:{type:ne.STRING,description:'The absolute time "M:B:S", e.g. "1:2:0"'},duration:{type:ne.STRING,description:'The note duration, e.g., "8n"'}},required:["note","time","duration"]}}}}),c=JSON.parse(i.text);L(c)}catch(n){const a=n instanceof Error?n.message:"An unknown error occurred.";console.error("Error generating AI bassline:",n),alert(`AI 貝斯線生成失敗: ${a}`)}finally{ie({type:null,isLoading:!1,error:null})}}},l=C((r,n)=>{v(a=>{const i=[...a],c=Oe();for(const y of ct.map(A=>A.value))n[y]&&(c[y]=n[y]);return i[r]=c,i})},[]),E=C(r=>{x(n=>{if(n&&n.sourceIndex===r)return null;const a=Z[r];return a?{pattern:a,sourceIndex:r}:null})},[Z]),f=C(r=>{O&&l(r,O.pattern)},[O,l]),R=async(r,n)=>{if(!ee.isLoading){if(!q){alert("請先在 API 設定中輸入您的 Gemini API 金鑰。");return}ie({type:"drums",isLoading:!0,error:null,drumChordIndex:n});try{const a=new Je({apiKey:q}),i=ct.map(A=>A.value).join(", "),c=await a.models.generateContent({model:"gemini-2.5-flash",contents:`User's request for a one-measure drum pattern: "${r}"`,config:{systemInstruction:`You are an expert drum machine programmer. Your task is to generate a one-measure (16-step) drum pattern based on a user's text description. The response MUST be a JSON object. The keys of the object must be instrument names from the following list: [${i}]. The value for each key must be a 4x4 array of booleans, representing 4 beats, each with 4 subdivisions (16th notes). 'true' means a hit, 'false' means a rest.`,responseMimeType:"application/json",responseSchema:{type:ne.OBJECT,properties:ct.reduce((A,V)=>(A[V.value]={type:ne.ARRAY,items:{type:ne.ARRAY,items:{type:ne.BOOLEAN}}},A),{})}}}),y=JSON.parse(c.text);l(n,y)}catch(a){const i=a instanceof Error?a.message:"An unknown error occurred.";console.error("Error generating drum pattern:",a),alert(`鼓組生成失敗: ${i}`)}finally{ie({type:null,isLoading:!1,error:null})}}};return se(()=>{const r=a=>{const i=a.target;if(i&&(i.tagName==="INPUT"||i.tagName==="SELECT"||i.tagName==="TEXTAREA"||i.isContentEditable))return;if(a.code==="Space"){a.preventDefault(),$e();return}const c=a.key.toLowerCase(),y=Kt[c];if(y&&!P.isPianoLoading){a.preventDefault();const{note:A,octave:V}=y,z=`${A}${V}`;g.has(z)||(Ke(A,V,!0),h(le=>new Set(le).add(z)))}},n=a=>{const i=a.key.toLowerCase(),c=a.target;if(c&&(c.tagName==="INPUT"||c.tagName==="SELECT"||c.tagName==="TEXTAREA"||c.isContentEditable))return;const y=Kt[i];if(y&&!P.isPianoLoading){a.preventDefault();const{note:A,octave:V}=y,z=`${A}${V}`;We(A,V,!0),h(le=>{const ue=new Set(le);return ue.delete(z),ue})}};return document.addEventListener("keydown",r),document.addEventListener("keyup",n),()=>{document.removeEventListener("keydown",r),document.removeEventListener("keyup",n)}},[P,Ke,We,g,$e]),e.jsxs(e.Fragment,{children:[e.jsx(zr,{isOpen:pe,onClose:()=>Fe(!1)}),e.jsx("div",{className:"min-h-screen bg-gray-800 text-gray-100 selection:bg-purple-500 selection:text-white",children:e.jsxs("div",{className:"container mx-auto p-2 sm:p-4 flex flex-col items-center space-y-4 sm:space-y-6",children:[e.jsxs("header",{className:"text-center my-3 sm:my-5",children:[e.jsx("h1",{className:"text-3xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500",children:"互動鋼琴工作室"}),e.jsx("p",{className:"text-gray-300 mt-2 text-xs sm:text-base",children:"釋放您的音樂創意！在這裡，您不僅可以自由彈奏、編曲，更能讓 AI 成為您的智慧編曲夥伴，輕鬆打造專屬伴奏。"}),e.jsxs("button",{onClick:()=>Fe(!0),className:"mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-gray-800",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 inline-block mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),"使用教學"]})]}),e.jsx(Or,{onNoteAttack:Ke,onNoteRelease:We,pressedKeys:g,accompanimentActiveNotes:me?re:new Set}),e.jsxs("div",{className:"w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6",children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx(Lr,{currentTransposition:P.currentTransposition,onTransposeChange:P.setTransposition}),e.jsxs("div",{className:"p-4 bg-gray-700 rounded-lg shadow-md space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-100",children:"主鍵盤設定 (Main Keyboard)"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"userPianoInstrument",className:"block text-sm font-medium text-gray-300 mb-1",children:"音色 (Instrument)"}),e.jsx("select",{id:"userPianoInstrument",value:P.currentUserPianoInstrument,onChange:r=>P.setUserPianoInstrument(r.target.value),className:"w-full p-2.5 bg-gray-600 border border-gray-500 rounded-md text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition-colors","aria-label":"選擇您的鋼琴音色",disabled:P.isPianoLoading,children:wr.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))}),P.isPianoLoading&&e.jsx("p",{className:"text-xs text-yellow-400 text-center mt-2",children:"鋼琴音色載入中..."})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"userPianoVolume",className:"block text-sm font-medium text-gray-300 mb-1",children:["音量 (Volume): ",w.toFixed(0)," dB"]}),e.jsx("input",{type:"range",id:"userPianoVolume",min:yr,max:vr,step:"1",value:w,onChange:r=>st(parseFloat(r.target.value)),className:"w-full h-2.5 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-400","aria-label":"調整主鍵盤音量"})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsx("label",{htmlFor:"showAccompanimentNotes",className:"text-sm font-medium text-gray-300",children:"顯示伴奏音符"}),e.jsx("button",{id:"showAccompanimentNotes",onClick:()=>he(!me),className:`px-3 py-1.5 rounded-md text-xs font-semibold transition-colors ${me?"bg-blue-600 hover:bg-blue-700":"bg-gray-500 hover:bg-gray-400"}`,"aria-pressed":me,children:me?"已啟用":"已停用"})]})]}),e.jsx(Fr,{onAddChord:Ee}),e.jsx(qr,{apiKey:q,onApiKeyChange:wt}),e.jsx(Yr,{onGenerate:At,isGenerating:ee.isLoading&&ee.type==="chords",generationError:ee.type==="chords"?ee.error:null,isApiKeySet:!!q}),e.jsx(Hr,{savedProgressions:Ae,onLoadProgression:vt,onDeleteProgression:jt})]}),e.jsxs("div",{className:"space-y-4 sm:space-y-6 flex flex-col",children:[e.jsx(_r,{progression:t,onRemoveChord:Re,onClearProgression:qe,onSaveProgression:yt,onReorderProgression:Nt,onUpdateChordInversion:De,currentlyPlayingChordIndex:ye,onStyleTransfer:Ct,isGeneratingStyle:ee.isLoading&&ee.type==="style",isApiKeySet:!!q,onSmartVoicing:St,isGeneratingVoicing:ee.isLoading&&ee.type==="voicing"}),e.jsx(Vr,{bpm:P.currentBPM,onBpmChange:P.setAccompanimentBPM,isBeat:Ie,accompanimentLayers:m,onAddAccompanimentLayer:xt,onRemoveAccompanimentLayer:ft,onUpdateAccompanimentLayer:bt,isPlaying:P.isAccompanimentPlaying,onPlay:P.startAccompaniment,onStop:de,isAudioReady:P.isAudioReady,chordProgressionEmpty:t.length===0,chordProgressionForCustomEditor:Pe,customRhythms:s,onUpdateCustomBeat:pt,reverbLevel:ve,onReverbLevelChange:Ce,delayLevel:Le,onDelayLevelChange:Ge,swing:Me,onSwingChange:ot,drumsEnabled:j,onDrumsEnabledChange:T,drumVolume:G,onDrumVolumeChange:nt,drumPattern:H,onDrumPatternChange:$,customDrumData:Z,onUpdateCustomDrumCell:gt,onGenerateDrumPattern:R,drumPatternClipboard:O,onCopyDrumPattern:E,onPasteDrumPattern:f,generationState:ee,isApiKeySet:!!q,bassEnabled:Y,onBassEnabledChange:oe,bassVolume:U,onBassVolumeChange:Te,bassPattern:_,onBassPatternChange:B,bassInstrument:M,onBassInstrumentChange:N,onGenerateAIBassline:Pt})]})]}),e.jsxs("footer",{className:"text-center text-gray-500 text-xs sm:text-sm mt-6 sm:mt-8 pb-4",children:[e.jsx("p",{children:"技術支持：React, Tailwind CSS, Tone.js, Gemini API"}),e.jsxs("p",{children:["© ",new Date().getFullYear()," by hsuchen"]})]})]})})]})},_t=document.getElementById("root");if(!_t)throw console.error("CRITICAL: Could not find root element to mount to. HTML structure issue?"),document.body.innerHTML=`
    <div style="color: #f3f4f6; background-color: #1f2937; padding: 20px; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
      <h1>應用程式啟動錯誤 (Application Startup Error)</h1>
      <p>無法找到用於掛載應用程式的根元素 (Could not find root element to mount to).</p>
      <p>請檢查 HTML 結構 (Please check the HTML structure).</p>
    </div>`,new Error("Could not find root element to mount to");try{lr.createRoot(_t).render(e.jsx(mt.StrictMode,{children:e.jsx(es,{})}))}catch(t){console.error("CRITICAL: Error during React rendering in main.tsx:",t),_t.innerHTML=`
    <div style="color: #f3f4f6; background-color: #1f2937; padding: 20px; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
      <h1 style="color: #ef4444; font-size: 1.5rem; margin-bottom: 1rem;">應用程式啟動時發生嚴重錯誤</h1>
      <h2 style="color: #f87171; font-size: 1.2rem; margin-bottom: 0.5rem;">(A critical error occurred and the application could not start)</h2>
      <p style="margin-bottom: 1rem;">請開啟瀏覽器的開發者控制台 (通常按 F12)，查看 "Console" 分頁獲取詳細錯誤資訊。</p>
      <p style="margin-bottom: 1rem;">(Please check the browser console (usually F12) for more details in the "Console" tab.)</p>
      ${t instanceof Error?`<pre style="background-color: #374151; padding: 10px; border-radius: 5px; max-width: 80%; overflow-wrap: break-word; white-space: pre-wrap; text-align: left;">${t.name}: ${t.message}
${t.stack}</pre>`:""}
    </div>
  `}
